<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="人生，总有些黑暗的隧道需要自己穿越">
    <meta name="author" content="Keep Team">
    
    <title>
        
            Elasticsearch |
        
        Keep Theme
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/logo.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"Keep Theme","author":"Keep Team","avatar":"/images/avatar.svg","logo":"/images/logo.svg","favicon":"/images/logo.svg"},"menu":{"home":"/","archives":"/archives"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":null,"category":false,"tag":false,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"toc":{"enable":false,"number":false,"expand_all":false,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":false,"preload":false},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":false,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.3"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Keep Theme
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Elasticsearch
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/avatar.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">Keep Team</span>
                                
                                    <span class="author-badge">Lv4</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2022-11-26 23:09:34</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Sun Aug 04 2024 23:40:21 GMT+0800">2024-08-04 23:40:21</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BB%84%E4%BB%B6/">分布式组件</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E7%BB%84%E4%BB%B6/">组件</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <meta name="referrer" content="no-referrer">



<p>参考文档：<a href="https://github.com/elastic/elasticsearch" target="_blank" rel="noopener">https://github.com/elastic/elasticsearch</a></p>
<p>git上的介绍：Elasticsearch是一个分布式基于restful的java语言编写的，服务于云端的搜索引擎，有以下几个优点。</p>
<ol>
<li>分布式高可用，每一个索引可以被配置为完全共享的分片，每一个分片有一个或多个副本，每一个分片的副本均提供查询搜索的功能操作。</li>
<li>多租户，支持多索引，索引级别的租户配置。</li>
<li>各种api支持，http，restful，api，所有的api操作会自动被节点操作重定向。</li>
<li>面向文档的，不用预先定义格式，可以为索引过程自定义结构。</li>
<li>可靠，对长期持久化提供异步后台写入。</li>
<li>近实时查询。</li>
<li>构建在lucene上，所有的分片都是全功能的lucene分片，lucene的功能均可以简单通过配置开放出来。</li>
<li>每一个操作都满足一致性的，简单的文档级别操作均是acid的。</li>
</ol>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>​    </p>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>参考：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/documents-indices.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.3/documents-indices.html</a></p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ol>
<li>为app或者website增加一个搜索的组件</li>
<li>存储分析日志，测量值，安全事件</li>
<li>实时使用机器学习自动对数据行为分析建模</li>
<li>作为自动化工作流的存储引擎</li>
<li>作为地理信息管理系统，管理，集成，分析空间数据</li>
<li>作为生物科学的搜索工具存储遗传进化的数据</li>
</ol>
<h2 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h2><p>ES将复杂的数据结构序列化成json格式，当文档被存储后，ES使用名为inverted index（倒排索引）来支持快速的全文索引，倒排索引列举了文档中的每一个单词及标识出单词在哪一个文档中出现。</p>
<p>索引可以被认为是优化过的文档的集合，每一个文档都是字段的集合，字段都是以键值对的方式存储着数据。默认的，每一种字段都有专门的优化过的数据存储结构。例如，大文本存储在倒排索引中，数值和地理字段存储在BKD中。通过使用每一种字段数据结构去拼接和返回结果达到高效查询的目的。</p>
<p>可以通过<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/query-dsl.html" target="_blank" rel="noopener">json风格</a>的查询语言或着<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/sql-overview.html" target="_blank" rel="noopener">sql风格</a>的查询语言进行搜索。同时ES支持聚合搜索</p>
<h1 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h1><ul>
<li>query和filter的区别，query会计算相关性，filter不会</li>
<li>查询时可结合分词器，在字段定义时，可同时指定构建时分析器</li>
<li>在某些情况下，如果是前缀匹配，可以考虑结合edge-egram，或者Suggester（一种提示语，可以根据term或者phase进行近似匹配）</li>
</ul>
<h2 id="常用查询"><a href="#常用查询" class="headerlink" title="常用查询"></a>常用查询</h2><p>检索内嵌对象中，某个字段不存在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;nested&quot;: &#123;</span><br><span class="line">            &quot;path&quot;: &quot;skuDocuments&quot;,</span><br><span class="line">            &quot;query&quot;: &#123;</span><br><span class="line">              &quot;bool&quot;: &#123;</span><br><span class="line">                &quot;must_not&quot;: &#123;</span><br><span class="line">                  &quot;exists&quot;: &#123;</span><br><span class="line">                    &quot;field&quot;: &quot;skuDocuments.price&quot;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="查询数量"><a href="#查询数量" class="headerlink" title="查询数量"></a>查询数量</h2><p>常用的查询使用search的RestApi，查询匹配的数量使用的是count的RestApi，相比使用聚合，效率快的多</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-count.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-count.html</a></p>
<h2 id="查询分析语句"><a href="#查询分析语句" class="headerlink" title="查询分析语句"></a>查询分析语句</h2><p>如果想查看DSL语句（类似json格式的查询语句），可以增加profile字段，显示耗时情况</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-profile.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.14/search-profile.html</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET saas-mcloud-plug-saas_cdp_bid_tag_user_match_tag_att/_search?human=true</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"profile"</span>: <span class="string">"true"</span>,</span><br><span class="line">  <span class="attr">"query"</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时也可以在kibana上查看到耗时情况</p>
<p><img src="/2022/11/26/3_Elasticsearch/image2.png" alt="image-20220625171540368" loading="lazy"></p>
<h1 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h1><p>更新有两种方式，bulk的put。或者update_by_query。</p>
<p>自测小数据量（1K）的情况下，update_by_query更新速度要优于put。但update_by_query不会受限查询大小限制，不用分批滚动。</p>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h3 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h3><h3 id="Term-Dictionary"><a href="#Term-Dictionary" class="headerlink" title="Term Dictionary"></a>Term Dictionary</h3><p>为了加快查询速度，这里建立了倒排索引，可以根据关键字快速查询到文档，结构如下，Term对应到具体的DocId</p>
<p><img src="/2022/11/26/3_Elasticsearch/image8.png" alt loading="lazy"></p>
<h3 id="Term-Index"><a href="#Term-Index" class="headerlink" title="Term Index"></a>Term Index</h3><p>在磁盘中保存Term，查询时性能影响较大，Elasticsearch采用内存保存Term，但Term太多，放内存不太合适，所以有了Term Index，</p>
<p><img src="/2022/11/26/3_Elasticsearch/image9.png" alt loading="lazy"></p>
<p>树上不会存储所有的term，值保存term的前缀，通过前缀可以快速定位到term directionary的offset，从offset向后查找</p>
<p><img src="/2022/11/26/3_Elasticsearch/image10.png" alt loading="lazy"></p>
<p>但是Term Index还是比较大，如果以Map的形式存储，空间占用还是比较大，这里采用FST的的压缩技术，从而将Term Index存储到内存中。</p>
<p>定位到posting list后，即可找到对应文档，但是posting list还是比较大，为了压缩存储，采用增量编码压缩。每个id按照顺序存放在bitmap里，但是以65535（2^16-1）作为一个块，第二个块从65536~131071，以此类推。普通的bitmap，一个字节可以存储8个文档。有关id的选择，有一篇博客：<a href="https://blog.mikemccandless.com/2014/05/choosing-fast-unique-identifier-uuid.html。" target="_blank" rel="noopener">https://blog.mikemccandless.com/2014/05/choosing-fast-unique-identifier-uuid.html。</a></p>
<h1 id="分词"><a href="#分词" class="headerlink" title="分词"></a>分词</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>主要包含3个基本的概念：字符过滤器（Character filters），词元器（Tokenizer），词元过滤器（Token filter）</p>
<h3 id="Character-Filter"><a href="#Character-Filter" class="headerlink" title="Character Filter"></a>Character Filter</h3><p>将原始文本以流的形式接收，输出字符，并对流中做增加，删除，修改部分字符等操作，例如去除html中的&lt;br&gt;标签。一个分词器可包含<strong>0或多个</strong>字符过滤器</p>
<h3 id="Tokenizer"><a href="#Tokenizer" class="headerlink" title="Tokenizer"></a>Tokenizer</h3><p><strong>重点使用</strong>。接收流形式过来的字符，拆分成独立的词元，并输出。例如whitespace分词器把”Quick brown fox!”分成[Quick, brown, fox!]。一个分词器只能包含<strong>1个</strong>词元器。</p>
<h3 id="Token-Filter"><a href="#Token-Filter" class="headerlink" title="Token Filter"></a>Token Filter</h3><p>过滤处理词元流，比如，把所有词元小写化，去除停顿词。一个分词器可以包含<strong>0或多个</strong>词元过滤器</p>
<h2 id="分词插件"><a href="#分词插件" class="headerlink" title="分词插件"></a>分词插件</h2><p>elasticsearch提供了很多分词工具，但是对中文不友好，需要自行安装中文分词插件，目前较为常用的是IK分词</p>
<p>es内置了很多分词器，可以满足常用需求，有面向词语的：Standard Tokenizer（默认），Lowercase Tokenize。有将单词分割为部分的：n-gram Tokenizer，Edge n-gram Tokenizer。有结构化处理文本的：Pattern Tokenizer，Path tokenizer</p>
<h2 id="简单应用"><a href="#简单应用" class="headerlink" title="简单应用"></a>简单应用</h2><h3 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h3><p>在某些特殊的情况下，需要实现类似数据库的模糊匹配需求，尽管可通过Wildcard实现，但检索性能较差，可考虑在构建索引时，利用分词器，将原始文本拆分为多个部分，后续检索时，可根据单词匹配快速检索数据，以空间换时间。</p>
<ol>
<li><p>字段定义</p>
<blockquote>
<p>由于n-gram默认的最大元数量有限制，这里可以通过max_ngram_diff进行调整。定义时，自定义了分词器，分词器采用ngram类型，并指定了最小最大元，单词仅收集单词（字母中文）和数字（123等），<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/analysis-ngram-tokenizer.html" target="_blank" rel="noopener">官网详情介绍</a>。定义时username在构建时根据ngram分词，检索词根据标准分词</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">PUT saas-export-goods-reviews-base2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"max_ngram_diff"</span>:<span class="number">3</span>,</span><br><span class="line">    <span class="attr">"analysis"</span>: &#123;</span><br><span class="line">      <span class="attr">"analyzer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_analyzer"</span>: &#123;</span><br><span class="line">          <span class="attr">"tokenizer"</span>: <span class="string">"my_tokenizer"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"tokenizer"</span>: &#123;</span><br><span class="line">        <span class="attr">"my_tokenizer"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"ngram"</span>,</span><br><span class="line">          <span class="attr">"min_gram"</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">"max_gram"</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">"token_chars"</span>: [</span><br><span class="line">            <span class="string">"letter"</span>,</span><br><span class="line">            <span class="string">"digit"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">      <span class="attr">"comment"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"email"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"goodsCode"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"personalName"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="attr">"analyzer"</span>: <span class="string">"my_analyzer"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"reviewsCode"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"username"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="attr">"analyzer"</span>: <span class="string">"my_analyzer"</span>,</span><br><span class="line">        <span class="attr">"search_analyzer"</span>: <span class="string">"standard"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询检索，确定分词效果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST saas-export-goods-reviews-base2/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"analyzer"</span>: <span class="string">"my_analyzer"</span>,</span><br><span class="line">  <span class="attr">"text"</span>: <span class="string">"uu325t4"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>效果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">PUT saas-export-goods-reviews-base2/_doc/12312</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"username"</span>: <span class="string">"uu3321"</span></span><br><span class="line">&#125; </span><br><span class="line">POST saas-export-goods-reviews-base2/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"query"</span>: &#123;</span><br><span class="line">    <span class="attr">"bool"</span>: &#123;</span><br><span class="line">      <span class="attr">"should"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"match"</span>: &#123;</span><br><span class="line">            <span class="attr">"username"</span>: <span class="string">"uu3"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 效果</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"took"</span> : <span class="number">261</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"skipped"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hits"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : &#123;</span><br><span class="line">      <span class="attr">"value"</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"relation"</span> : <span class="string">"eq"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"max_score"</span> : <span class="number">10.640834</span>,</span><br><span class="line">    <span class="attr">"hits"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"saas-export-goods-reviews-base2"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"12312"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">10.640834</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"username"</span> : <span class="string">"uu3321"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




</li>
</ol>
<h1 id="存储结构"><a href="#存储结构" class="headerlink" title="存储结构"></a>存储结构</h1><blockquote>
<p>lucene文件结构：<a href="https://lucene.apache.org/core/9_9_1/core/org/apache/lucene/codecs/lucene99/package-summary.html#package.description" target="_blank" rel="noopener">https://lucene.apache.org/core/9_9_1/core/org/apache/lucene/codecs/lucene99/package-summary.html#package.description</a></p>
</blockquote>
<p>底层基于Lucene存储，    </p>
<h1 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h1><p>一般在修改数据字段时，不允许直接在已经新建的索引上修改，但日常工作中，难免遇到提前定义错了mapping类型，或索引内数据需要合并，分割。</p>
<p>经测试，只要通过spring自动创建的索引（会根据字段类型自动匹配映射类型），再想修改都不可能了。但是如果只是新增一个字段，同时指定正确的类型，这样是可以的。</p>
<h2 id="Reindex"><a href="#Reindex" class="headerlink" title="Reindex"></a>Reindex</h2><ol>
<li>先建立别名映射，将查询saas-export-goods-aliases的链接到export_goods</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"actions"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"add"</span>: &#123;</span><br><span class="line">        <span class="string">"index"</span>: <span class="string">"export_goods"</span>,</span><br><span class="line">        <span class="string">"alias"</span>: <span class="string">"saas-export-goods-aliases"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将程序中的索引换成别名</li>
</ol>
<p><img src="/2022/11/26/3_Elasticsearch/image.png" alt loading="lazy"></p>
<ol start="3">
<li><p>创建新的正确映射的索引，为数据迁移做准备</p>
<p>获取到原有索引映射</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">GET /export_goods/_mappings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"export_goods"</span> : &#123;</span><br><span class="line">    <span class="string">"mappings"</span> : &#123;</span><br><span class="line">      <span class="string">"properties"</span> : &#123;</span><br><span class="line">        <span class="string">"count"</span> : &#123;</span><br><span class="line">          <span class="string">"type"</span> : <span class="string">"long"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"goodsMaps"</span> : &#123;</span><br><span class="line">          <span class="string">"type"</span> : <span class="string">"nested"</span>,</span><br><span class="line">          <span class="string">"properties"</span> : &#123;</span><br><span class="line">            <span class="string">"groupCode"</span> : &#123;</span><br><span class="line">              <span class="string">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">              <span class="string">"fields"</span> : &#123;</span><br><span class="line">                <span class="string">"keyword"</span> : &#123;</span><br><span class="line">                  <span class="string">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">                  <span class="string">"ignore_above"</span> : 256</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"sort"</span> : &#123;</span><br><span class="line">              <span class="string">"type"</span> : <span class="string">"long"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"goodsMaps2"</span> : &#123;</span><br><span class="line">          <span class="string">"properties"</span> : &#123;</span><br><span class="line">            <span class="string">"groupCode"</span> : &#123;</span><br><span class="line">              <span class="string">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">              <span class="string">"fields"</span> : &#123;</span><br><span class="line">                <span class="string">"keyword"</span> : &#123;</span><br><span class="line">                  <span class="string">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">                  <span class="string">"ignore_above"</span> : 256</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"id"</span> : &#123;</span><br><span class="line">          <span class="string">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="string">"fields"</span> : &#123;</span><br><span class="line">            <span class="string">"keyword"</span> : &#123;</span><br><span class="line">              <span class="string">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">              <span class="string">"ignore_above"</span> : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"name"</span> : &#123;</span><br><span class="line">          <span class="string">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"pid"</span> : &#123;</span><br><span class="line">          <span class="string">"type"</span> : <span class="string">"long"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>创建新的索引</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">PUT /export_goods_copy/</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="string">"mappings"</span> : &#123;</span><br><span class="line">      <span class="string">"properties"</span> : &#123;</span><br><span class="line">        <span class="string">"count"</span> : &#123;</span><br><span class="line">          <span class="string">"type"</span> : <span class="string">"long"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"goodsMaps"</span> : &#123;</span><br><span class="line">          <span class="string">"type"</span> : <span class="string">"nested"</span>,</span><br><span class="line">          <span class="string">"properties"</span> : &#123;</span><br><span class="line">            <span class="string">"groupCode"</span> : &#123;</span><br><span class="line">              <span class="string">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">              <span class="string">"fields"</span> : &#123;</span><br><span class="line">                <span class="string">"keyword"</span> : &#123;</span><br><span class="line">                  <span class="string">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">                  <span class="string">"ignore_above"</span> : 256</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"sort"</span> : &#123;</span><br><span class="line">              <span class="string">"type"</span> : <span class="string">"long"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"goodsMaps2"</span> : &#123;</span><br><span class="line">          <span class="string">"type"</span> : <span class="string">"nested"</span>,</span><br><span class="line">          <span class="string">"properties"</span> : &#123;</span><br><span class="line">            <span class="string">"groupCode"</span> : &#123;</span><br><span class="line">              <span class="string">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">              <span class="string">"fields"</span> : &#123;</span><br><span class="line">                <span class="string">"keyword"</span> : &#123;</span><br><span class="line">                  <span class="string">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">                  <span class="string">"ignore_above"</span> : 256</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"id"</span> : &#123;</span><br><span class="line">          <span class="string">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">          <span class="string">"fields"</span> : &#123;</span><br><span class="line">            <span class="string">"keyword"</span> : &#123;</span><br><span class="line">              <span class="string">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">              <span class="string">"ignore_above"</span> : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"name"</span> : &#123;</span><br><span class="line">          <span class="string">"type"</span> : <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"pid"</span> : &#123;</span><br><span class="line">          <span class="string">"type"</span> : <span class="string">"long"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>执行reIndex</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /_reindex?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"source"</span>: &#123;</span><br><span class="line">    <span class="string">"index"</span>: <span class="string">"export_goods"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"dest"</span>: &#123;</span><br><span class="line">    <span class="string">"index"</span>: <span class="string">"export_goods_copy"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>将别名映射到新的索引中，之前的索引可以删掉了。保证别名未删除就行</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"actions"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"remove"</span>: &#123;</span><br><span class="line">        <span class="string">"index"</span>: <span class="string">"export_goods"</span>,</span><br><span class="line">        <span class="string">"alias"</span>: <span class="string">"saas-export-goods-aliases"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"add"</span>: &#123;</span><br><span class="line">        <span class="string">"index"</span>: <span class="string">"export_goods_copy"</span>,</span><br><span class="line">        <span class="string">"alias"</span>: <span class="string">"saas-export-goods-aliases"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>查看映射关系</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _alias/saas-export-goods-aliases</span><br></pre></td></tr></table></figure>





<h1 id="Spring-data"><a href="#Spring-data" class="headerlink" title="Spring-data"></a>Spring-data</h1><ul>
<li>如果使用Repository，必须继承ElasticsearchRepository，在启动时会检查索引是否存在，如果不存在则会尝试根据Annotation构建Index。如果启动后删除了index，或者修改了index，没找到办法重新修改。手动再修改回来。</li>
</ul>
<h2 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h2><ul>
<li>在重建索引的过程中，如果遇到字段映射发生变更，是需要删除索引重建的。</li>
</ul>
<h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><ul>
<li>内嵌对象排序</li>
</ul>
<p>可以利用bool构造多个查询条件，sort根据多个字段进行排序</p>
<p>查询：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/query-dsl-nested-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.14/query-dsl-nested-query.html</a></p>
<p>排序：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/sort-search-results.html#nested-sorting" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.14/sort-search-results.html#nested-sorting</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">GET /export_goods/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool": &#123;</span><br><span class="line">      "must": [</span><br><span class="line">        &#123;</span><br><span class="line">          "nested": &#123;</span><br><span class="line">            "path": "goodsMaps",</span><br><span class="line">            "query": &#123;</span><br><span class="line">                "match": &#123; "goodsMaps.groupCode": "DDDDD" &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "sort": [</span><br><span class="line">    &#123;</span><br><span class="line">      "goodsMaps.sort": &#123;</span><br><span class="line">        "order": "asc",</span><br><span class="line">        "nested": &#123;</span><br><span class="line">          "path": "goodsMaps",</span><br><span class="line">          "filter": &#123;</span><br><span class="line">             "match": &#123; "goodsMaps.groupCode": "DDDDD" &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "count": &#123;</span><br><span class="line">        "order": "asc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>spring-data-elasticsearch</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">BoolQueryBuilder queryBuilder = boolQuery();</span><br><span class="line">MatchQueryBuilder matchQueryBuilder = <span class="keyword">new</span> MatchQueryBuilder(<span class="string">"goodsMaps.groupCode"</span>,<span class="string">"DDDDD"</span>);</span><br><span class="line">NestedQueryBuilder nestedQueryBuilder = <span class="keyword">new</span> NestedQueryBuilder(<span class="string">"goodsMaps"</span>,matchQueryBuilder, ScoreMode.Avg);</span><br><span class="line">queryBuilder.must(nestedQueryBuilder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FieldSortBuilder sortBuilder = <span class="keyword">new</span> FieldSortBuilder(<span class="string">"goodsMaps.sort"</span>);</span><br><span class="line">NestedSortBuilder nestedSortBuilder = <span class="keyword">new</span> NestedSortBuilder(<span class="string">"goodsMaps"</span>);</span><br><span class="line">nestedSortBuilder.setFilter(matchQueryBuilder);</span><br><span class="line">sortBuilder.setNestedSort(nestedSortBuilder);</span><br><span class="line">sortBuilder.order(SortOrder.ASC);</span><br><span class="line"></span><br><span class="line">NativeSearchQuery nativeSearchQuery = <span class="keyword">new</span> NativeSearchQueryBuilder()</span><br><span class="line">    .withQuery(queryBuilder)</span><br><span class="line">    .withSort(sortBuilder)</span><br><span class="line">    .withPageable(PageRequest.of(<span class="number">0</span>, <span class="number">2</span>))</span><br><span class="line">    .build();</span><br><span class="line">Page&lt;Goods&gt; search = repository.search(nativeSearchQuery);</span><br></pre></td></tr></table></figure>



<h2 id="字段映射"><a href="#字段映射" class="headerlink" title="字段映射"></a>字段映射</h2><ul>
<li>一般text字段默认会被索引，如果需要精确查询时，建议采用term</li>
<li>当需要精确匹配时，可以设置Field的别名，将别名类型设置为keyword，查询时指定别名查询，如下所示，goodsCode原本类型为text，别名keyword，类型为keyword</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"goodsCode"</span> : &#123;</span><br><span class="line">    <span class="string">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">    <span class="string">"fields"</span> : &#123;</span><br><span class="line">        <span class="string">"keyword"</span> : &#123;</span><br><span class="line">            <span class="string">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">            <span class="string">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>spring-data-elasticsearch的注解映射时，如果是String类型，会映射成muti-field，主类型为text，辅类型有一个keyword</li>
</ul>
<h1 id="简单安装"><a href="#简单安装" class="headerlink" title="简单安装"></a>简单安装</h1><ol>
<li>安装elastisearch软件包，<a href="https://www.elastic.co/cn/downloads/elasticsearch" target="_blank" rel="noopener">前往这里</a></li>
<li>解压安装</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-7.3.2</span><br><span class="line">ll</span><br><span class="line">total 1048</span><br><span class="line">drwxr-xr-x@ 14 weiqian  staff     448  8 30 21:23 .&#x2F;</span><br><span class="line">drwxr-xr-x  27 weiqian  staff     864  8 31 17:38 ..&#x2F;</span><br><span class="line">-rw-r--r--@  1 weiqian  staff   13675  9  6  2019 LICENSE.txt</span><br><span class="line">-rw-r--r--@  1 weiqian  staff  502598  9  6  2019 NOTICE.txt</span><br><span class="line">-rw-r--r--@  1 weiqian  staff    8500  9  6  2019 README.textile</span><br><span class="line">drwxr-xr-x@ 22 weiqian  staff     704  9  6  2019 bin&#x2F;</span><br><span class="line">drwxr-xr-x@ 10 weiqian  staff     320  8 30 21:39 config&#x2F;</span><br><span class="line">drwxr-xr-x   3 weiqian  staff      96  8 30 18:32 data&#x2F;</span><br><span class="line">drwxr-xr-x@  3 weiqian  staff      96  9  6  2019 jdk&#x2F;</span><br><span class="line">drwxr-xr-x@ 42 weiqian  staff    1344  9  6  2019 lib&#x2F;</span><br><span class="line">drwxr-xr-x@ 14 weiqian  staff     448 10 25 13:42 logs&#x2F;</span><br><span class="line">drwxr-xr-x@ 33 weiqian  staff    1056  9  6  2019 modules&#x2F;</span><br><span class="line">-rw-r--r--   1 weiqian  staff       5  8 30 21:38 pid</span><br><span class="line">drwxr-xr-x@  2 weiqian  staff      64  9  6  2019 plugins&#x2F;</span><br></pre></td></tr></table></figure>

<ol>
<li>进入bin目录，执行./elasticsearch</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  elasticsearch-7.3.2 cd</span><br><span class="line">➜  bin .&#x2F;elasticsearch</span><br></pre></td></tr></table></figure>

<ol>
<li>加入两个节点集群，将data和日志输出到不同的目录即可，配置文件默认读取的是conf下的</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;elasticsearch -Epath.data&#x3D;data2 -Epath.logs&#x3D;log2</span><br><span class="line">.&#x2F;elasticsearch -Epath.data&#x3D;data3 -Epath.logs&#x3D;log3</span><br></pre></td></tr></table></figure>

<ol>
<li>正常情况下会输出</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[2020-10-25T13:42:41,898][INFO ][o.e.c.s.ClusterApplierService] [weiqiandeMacBook-Pro.local] master node changed &#123;previous [], current [&#123;weiqiandeMacBook-Pro.local&#125;&#123;zCAE8hSGR9-B3GYbxI7dsw&#125;&#123;GALzOcCeQPeeFos5e7K7zQ&#125;&#123;127.0.0.1&#125;&#123;127.0.0.1:9300&#125;&#123;dim&#125;&#123;xpack.installed&#x3D;true&#125;]&#125;, term: 4, version: 26, reason: Publication&#123;term&#x3D;4, version&#x3D;26&#125;</span><br><span class="line">[2020-10-25T13:42:41,925][INFO ][o.e.h.AbstractHttpServerTransport] [weiqiandeMacBook-Pro.local] publish_address &#123;127.0.0.1:9200&#125;, bound_addresses &#123;[::1]:9200&#125;, &#123;127.0.0.1:9200&#125;</span><br><span class="line">[2020-10-25T13:42:41,925][INFO ][o.e.n.Node               ] [weiqiandeMacBook-Pro.local] started</span><br><span class="line">[2020-10-25T13:42:42,096][INFO ][o.e.l.LicenseService     ] [weiqiandeMacBook-Pro.local] license [909422ec-ff18-4f81-9379-013fd25f0dea] mode [basic] - valid</span><br><span class="line">[2020-10-25T13:42:42,097][INFO ][o.e.x.s.s.SecurityStatusChangeListener] [weiqiandeMacBook-Pro.local] Active license is now [BASIC]; Security is disabled</span><br><span class="line">[2020-10-25T13:42:42,101][INFO ][o.e.g.GatewayService     ] [weiqiandeMacBook-Pro.local] recovered [2] indices into cluster_state</span><br><span class="line">[2020-10-25T13:42:42,300][INFO ][o.e.c.r.a.AllocationService] [weiqiandeMacBook-Pro.local] Cluster health status changed from [RED] to [YELLOW] (reason: [shards started [[my-index-000001][0], [test][0]] ...]).</span><br></pre></td></tr></table></figure>

<ol>
<li>可通过访问<a href="http://localhost:9200，验证是否单节点">http://localhost:9200，验证是否单节点</a></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET http:&#x2F;&#x2F;localhost:9200&#x2F;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;weiqiandeMacBook-Pro.local&quot;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</span><br><span class="line">  &quot;cluster_uuid&quot; : &quot;ZJ0Bs8TNQpq5dBgT9UUH1A&quot;,</span><br><span class="line">  &quot;version&quot; : &#123;</span><br><span class="line">    &quot;number&quot; : &quot;7.3.2&quot;,</span><br><span class="line">    &quot;build_flavor&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;build_type&quot; : &quot;tar&quot;,</span><br><span class="line">    &quot;build_hash&quot; : &quot;1c1faf1&quot;,</span><br><span class="line">    &quot;build_date&quot; : &quot;2019-09-06T14:40:30.409026Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot; : false,</span><br><span class="line">    &quot;lucene_version&quot; : &quot;8.1.0&quot;,</span><br><span class="line">    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,</span><br><span class="line">    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>通过健康检查接口查看集群是否正常，status为green表示正常，当为yellow时，表示一个节点功能全部正常，但是数据不能从另一个节点复制过来，如果时红色，表示数据不可用</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config       curl -X GET &quot;localhost:9200&#x2F;_cat&#x2F;health?v&amp;pretty&quot;</span><br><span class="line"></span><br><span class="line">epoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1603609613 07:06:53  elasticsearch green           3         3      4   2    0    0        0             0                  -                100.0%</span><br></pre></td></tr></table></figure>

<ol>
<li>一些参数</li>
</ol>
<p>搜索的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 63,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 5,</span><br><span class="line">    &quot;successful&quot; : 5,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">        &quot;value&quot;: 1000,</span><br><span class="line">        &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : null,</span><br><span class="line">    &quot;hits&quot; : [ &#123;</span><br><span class="line">      &quot;_index&quot; : &quot;bank&quot;,</span><br><span class="line">      &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">      &quot;_id&quot; : &quot;0&quot;,</span><br><span class="line">      &quot;sort&quot;: [0],</span><br><span class="line">      &quot;_score&quot; : null,</span><br><span class="line">      &quot;_source&quot; : &#123;&quot;account_number&quot;:0,&quot;balance&quot;:16623,&quot;firstname&quot;:&quot;Bradshaw&quot;,&quot;lastname&quot;:&quot;Mckenzie&quot;,&quot;age&quot;:29,&quot;gender&quot;:&quot;F&quot;,&quot;address&quot;:&quot;244 Columbus Place&quot;,&quot;employer&quot;:&quot;Euron&quot;,&quot;email&quot;:&quot;bradshawmckenzie@euron.com&quot;,&quot;city&quot;:&quot;Hobucken&quot;,&quot;state&quot;:&quot;CO&quot;&#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      &quot;_index&quot; : &quot;bank&quot;,</span><br><span class="line">      &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">      &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">      &quot;sort&quot;: [1],</span><br><span class="line">      &quot;_score&quot; : null,</span><br><span class="line">      &quot;_source&quot; : &#123;&quot;account_number&quot;:1,&quot;balance&quot;:39225,&quot;firstname&quot;:&quot;Amber&quot;,&quot;lastname&quot;:&quot;Duke&quot;,&quot;age&quot;:32,&quot;gender&quot;:&quot;M&quot;,&quot;address&quot;:&quot;880 Holmes Lane&quot;,&quot;employer&quot;:&quot;Pyrami&quot;,&quot;email&quot;:&quot;amberduke@pyrami.com&quot;,&quot;city&quot;:&quot;Brogan&quot;,&quot;state&quot;:&quot;IL&quot;&#125;</span><br><span class="line">    &#125;, ...</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>took</code> 表示es花费了多久时间运行查询，单位：毫秒</p>
<p><code>timed_out</code> 查询是否超时</p>
<p>_shards 搜索了多少分片，包括成功，失败，跳过</p>
<p>max_score 相关的文档查询的分数</p>
<p>hit.total.value 多少文档被匹配</p>
<p>hit.sort 文档排序位置</p>
<p>hit._score 文档的相关性得分（不适用match_all）</p>
<p>字段中搜索特定单词，可以使用match</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET &quot;localhost:9200&#x2F;bank&#x2F;_search?pretty&quot; -H &#39;Content-Type: application&#x2F;json&#39; -d&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;mill lane&quot; &#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#39;</span><br></pre></td></tr></table></figure>

<p>需要执行词组搜索，而不是匹配单个词，使用match_phrase</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET &quot;localhost:9200&#x2F;bank&#x2F;_search?pretty&quot; -H &#39;Content-Type: application&#x2F;json&#39; -d&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_phrase&quot;: &#123; &quot;address&quot;: &quot;mill lane&quot; &#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#39;</span><br></pre></td></tr></table></figure>

<p>可以使用bool组合查询，可以使用指定范围（必须包含must match，渴望包含should match，和不希望包含must not match）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET &quot;localhost:9200&#x2F;bank&#x2F;_search?pretty&quot; -H &#39;Content-Type: application&#x2F;json&#39; -d&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;age&quot;: &quot;40&quot; &#125; &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;state&quot;: &quot;ID&quot; &#125; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#39;</span><br></pre></td></tr></table></figure>

<p>must，should会贡献相关性分数，must_not作为过滤器，不贡献相关性分数，返回的结果会根据相关性排序，越相关越在前面。也可以使用其他的过滤器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET &quot;localhost:9200&#x2F;bank&#x2F;_search?pretty&quot; -H &#39;Content-Type: application&#x2F;json&#39; -d&#39;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;balance&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: 20000,</span><br><span class="line">            &quot;lte&quot;: 30000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#39;</span><br></pre></td></tr></table></figure>

<p>聚合查询时，先通过terms将数据聚合，内嵌avg聚合函数将聚合的数据进行分组</p>
<h1 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h1><p>集成了promethus+grafana+elasticsearch_exporter。也可以用cerbro看。</p>
<ul>
<li>elasticsearch_exporter</li>
</ul>
<p>github：<a href="https://github.com/prometheus-community/elasticsearch_exporter" target="_blank" rel="noopener">https://github.com/prometheus-community/elasticsearch_exporter</a></p>
<p>比较傻瓜，下载下来之后，配置一下链接的elasticsearch_exporter即可，访问<a href="http://localhost:9114/metrics可以测试是否取到监控数据" target="_blank" rel="noopener">http://localhost:9114/metrics可以测试是否取到监控数据</a></p>
<ul>
<li>promethus</li>
</ul>
<p>github：<a href="https://github.com/prometheus/prometheus" target="_blank" rel="noopener">https://github.com/prometheus/prometheus</a></p>
<p>需要找到安装目录下的prometheus.yml文件，配置一下scrape_configs这一节，把exporter的地址配上去，配置手册如下：<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label &#96;job&#x3D;&lt;job_name&gt;&#96; to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &quot;elasticsearch_exporter&quot;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &#39;&#x2F;metrics&#39;</span><br><span class="line">    # scheme defaults to &#39;http&#39;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&quot;localhost:9114&quot;]</span><br></pre></td></tr></table></figure>

<p>配置成功后，直接启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;prometheus --config.file&#x3D;prometheus.yml</span><br></pre></td></tr></table></figure>

<p>启动后，可以通过访问<a href="http://localhost:9090/metrics测试是否获取到监控指标数据" target="_blank" rel="noopener">http://localhost:9090/metrics测试是否获取到监控指标数据</a></p>
<ul>
<li>grafana</li>
</ul>
<p>官网：<a href="https://grafana.com/grafana/download?pg=get&amp;plcmt=selfmanaged-box1-cta1&amp;platform=mac" target="_blank" rel="noopener">https://grafana.com/grafana/download?pg=get&amp;plcmt=selfmanaged-box1-cta1&amp;platform=mac</a></p>
<p>下载后，配置文件在conf目录下，defaults.ini（里面有admin密码），官方文档如下：</p>
<p><a href="https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/" target="_blank" rel="noopener">https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/</a></p>
<p>启动命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;grafana-server web</span><br></pre></td></tr></table></figure>

<p>启动后，访问<a href="http://localhost:3000，默认账号密码都是admin">http://localhost:3000，默认账号密码都是admin</a></p>
<p>新增一个prometheus的数据源</p>
<p><img src="/2022/11/26/3_Elasticsearch/image5.png" alt="image-20220625171540368" loading="lazy"></p>
<p>然后可以导入相应的模板，elasticsearch的id：2322</p>
<p><img src="/2022/11/26/3_Elasticsearch/image4.png" alt="image-20220625171540368" loading="lazy"></p>
<p>会从官网下载一个模板，里面指标挺丰富的</p>
<p><img src="/2022/11/26/3_Elasticsearch/image5.png" alt="image-20220625171540368" loading="lazy"></p>
<p>效果如下：</p>
<p><img src="/2022/11/26/3_Elasticsearch/image5.png" alt="image-20220625171540368" loading="lazy"></p>
<h1 id="源码调试"><a href="#源码调试" class="headerlink" title="源码调试"></a>源码调试</h1><blockquote>
<p>源码使用的是gradlew构建，官网介绍：<a href="https://github.com/elastic/elasticsearch/blob/7.16/TESTING.asciidoc" target="_blank" rel="noopener">https://github.com/elastic/elasticsearch/blob/7.16/TESTING.asciidoc</a></p>
</blockquote>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E7%BB%84%E4%BB%B6/">组件</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2023/02/13/1_%E3%80%8APresto%E5%AE%9E%E6%88%98%E3%80%8B%E7%AC%94%E8%AE%B0/"
                                   title="《Presto实战》笔记"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">《Presto实战》笔记</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2022/11/13/3_Kafka/"
                                   title="Kafka"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Kafka</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2024
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Keep Team</a>
        
    </div>

    <div class="theme-info info-item">
        由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;&&nbsp;主题&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    

    <!-- tablet toc -->
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->


<!-- lazyload -->


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
