<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="人生，总有些黑暗的隧道需要自己穿越">
    <meta name="author" content="EmiyaQ">
    
    <title>
        
            Kafka |
        
        The winter sunshine
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/logo.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"sangrealwar.github.io","root":"/","language":"zh-CN","path":"search.xml"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"The winter sunshine","author":"EmiyaQ","avatar":"/images/pig.png","logo":"/images/logo.svg","favicon":"/images/logo.svg"},"menu":{"home":"/","archives":"/archives","categories":"/categories"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":null,"category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":false,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":true},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":false,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.3"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               The winter sunshine
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                分类
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                            分类
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Kafka
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/pig.png">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">EmiyaQ</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2022-11-13 10:10:39</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Sun Oct 27 2024 18:34:40 GMT+0800">2024-10-27 18:34:40</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BB%84%E4%BB%B6/">分布式组件</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E7%BB%84%E4%BB%B6/">组件</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <meta name="referrer" content="no-referrer"/>

<p>Kafka作为高性能事件流平台，可以存储，发布订阅，处理各种流事件，被广泛用于消息中间件，流处理组件等应用上。</p>
<p>Log消息存储</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://kafka.apache.org/0100/documentation.html#log" >https://kafka.apache.org/0100/documentation.html#log<i class="fas fa-external-link-alt"></i></a></p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><h2 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h2><ul>
<li>发送消息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/kafka-console-producer.sh --broker-list localhost:9092  --topic tmp-offset</span><br></pre></td></tr></table></figure>

<ul>
<li>消费消息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic tmp-offset --from-beginning --group aaaa123</span><br></pre></td></tr></table></figure>

<ul>
<li>查看消费者偏移量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list localhost:9092 --topic tmp-offset</span><br></pre></td></tr></table></figure>



<h2 id="spring-kafka"><a href="#spring-kafka" class="headerlink" title="spring-kafka"></a>spring-kafka</h2><ul>
<li>定义kafka配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConsumerFactory&lt;Integer, String&gt; <span class="title function_">consumerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultKafkaConsumerFactory</span>&lt;&gt;(consumerProps());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">consumerProps</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">&quot;group&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, IntegerDeserializer.class);</span><br><span class="line">        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);</span><br><span class="line">        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">&quot;earliest&quot;</span>);</span><br><span class="line">        <span class="comment">//2 手动提交offset</span></span><br><span class="line">        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,<span class="string">&quot;false&quot;</span>);</span><br><span class="line"><span class="comment">//3. 分配策略，改为随机分配</span></span><br><span class="line">        <span class="comment">//props.put(ConsumerConfig.PARTITION_ASSIGNMENT_STRATEGY_CONFIG, &quot;org.apache.kafka.clients.consumer.RoundRobinAssignor&quot;);</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> props;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ProducerFactory&lt;Integer, String&gt; <span class="title function_">producerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultKafkaProducerFactory</span>&lt;&gt;(senderProps());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">senderProps</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">        props.put(ProducerConfig.LINGER_MS_CONFIG, <span class="number">10</span>);</span><br><span class="line">        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, IntegerSerializer.class);</span><br><span class="line">        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">return</span> props;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KafkaTemplate&lt;Integer, String&gt; <span class="title function_">kafkaTemplate</span><span class="params">(ProducerFactory&lt;Integer, String&gt; producerFactory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KafkaTemplate</span>&lt;Integer, String&gt;(producerFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KafkaListenerContainerFactory&lt;ConcurrentMessageListenerContainer&lt;Integer, String&gt;&gt; <span class="title function_">kafkaContainerFactory</span><span class="params">(ConsumerFactory&lt;Integer, String&gt; consumerFactory)</span> &#123;</span><br><span class="line">        ConcurrentKafkaListenerContainerFactory&lt;Integer, String&gt; factory = <span class="keyword">new</span> <span class="title class_">ConcurrentKafkaListenerContainerFactory</span>&lt;&gt;();</span><br><span class="line">        factory.setConsumerFactory(consumerFactory);</span><br><span class="line">        factory.setConcurrency(<span class="number">3</span>);</span><br><span class="line">        factory.getContainerProperties().setPollTimeout(<span class="number">3000</span>);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>消费者</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class TestConsumer &#123;</span><br><span class="line"></span><br><span class="line">    @KafkaListener(topics = &quot;bid-uc&quot;,</span><br><span class="line">            groupId = &quot;saas-mcloud-cdp-bid-uc-tag-core&quot;,</span><br><span class="line">            containerFactory = &quot;kafkaContainerFactory&quot;)</span><br><span class="line">    public void test(ConsumerRecord&lt;String, String&gt; record)&#123;</span><br><span class="line">        System.out.println(&quot;项目2收到消息：&quot;+record.value());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>消费者异常阻塞</li>
</ul>
<p>正常配置消费者，如果出现异常，会重复消费</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">    public KafkaListenerContainerFactory&lt;ConcurrentMessageListenerContainer&lt;Integer, String&gt;&gt; kafkaContainerFactoryV2() &#123;</span><br><span class="line">        ConcurrentKafkaListenerContainerFactory&lt;Integer, String&gt; factory = new ConcurrentKafkaListenerContainerFactory&lt;&gt;();</span><br><span class="line">        Map&lt;String, Object&gt; props = new HashMap&lt;&gt;();</span><br><span class="line">        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, &quot;localhost:9092&quot;);</span><br><span class="line">        props.put(ConsumerConfig.GROUP_ID_CONFIG, &quot;group&quot;);</span><br><span class="line">        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);</span><br><span class="line">        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);</span><br><span class="line">        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, &quot;latest&quot;);</span><br><span class="line">        //2 手动提交offset</span><br><span class="line">        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, &quot;false&quot;);</span><br><span class="line">        factory.setConsumerFactory(new DefaultKafkaConsumerFactory&lt;&gt;(props));</span><br><span class="line">        factory.setConcurrency(3);</span><br><span class="line">        factory.setBatchListener(true);</span><br><span class="line">        factory.getContainerProperties().setPollTimeout(3000);</span><br><span class="line">        factory.getContainerProperties().setAckMode(ContainerProperties.AckMode.MANUAL_IMMEDIATE);</span><br><span class="line">//        factory.setCommonErrorHandler(new DefaultErrorHandler(new FixedBackOff(2000L, 2L)));</span><br><span class="line">        return factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">@KafkaListener(topics = &quot;topicV2&quot;,</span><br><span class="line">            groupId = &quot;tmp&quot;,</span><br><span class="line">            containerFactory = &quot;kafkaContainerFactoryV2&quot;, properties = &#123;&quot;max.poll.records:1&quot;&#125;)</span><br><span class="line">    public void testV2(List&lt;ConsumerRecord&lt;String, String&gt;&gt; records, Acknowledgment acknowledgment) &#123;</span><br><span class="line">        for (ConsumerRecord&lt;String, String&gt; record : records) &#123;</span><br><span class="line"></span><br><span class="line">            System.out.println(LocalDateTime.now()+&quot;项目2收到消息：&quot; + record.value());</span><br><span class="line"></span><br><span class="line">            if (record.value().equals(&quot;异常&quot;)) &#123;</span><br><span class="line">                throw new RuntimeException();</span><br><span class="line">            &#125;</span><br><span class="line">            acknowledgment.acknowledge();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>聪明的小伙伴可以发现，如果使用原生的KafkaClient，poll后，如果在commit之前，如果throw异常，那下次如果消费到正常消息时，是会忽略这次异常，并没有无限重试，而spring-kafka客户端为什么会阻塞拉取呢，难道seek过吗？</p>
<p>没错，默认的KafkaMessageListenerContainer当ErrorHandler未指定时，使用了默认处理器，会默认10次请求，然后重新seek到原来的位置方便下次拉取，从而达到无限重试的目的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.kafka.listener.KafkaMessageListenerContainer#doStart</span><br><span class="line">protected void doStart() &#123;</span><br><span class="line">		if (isRunning()) &#123;</span><br><span class="line">			return;</span><br><span class="line">		&#125;</span><br><span class="line">		// 其他初始化代码</span><br><span class="line">		</span><br><span class="line">		// 重点初始化Consumer客户端</span><br><span class="line">		this.listenerConsumer = new ListenerConsumer(listener, listenerType);</span><br><span class="line">		</span><br><span class="line">		// 其他初始化代码</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">org.springframework.kafka.listener.KafkaMessageListenerContainer.ListenerConsumer#ListenerConsumer</span><br><span class="line">ListenerConsumer(GenericMessageListener&lt;?&gt; listener, ListenerType listenerType) &#123;</span><br><span class="line"></span><br><span class="line">			if (this.isBatchListener) &#123;</span><br><span class="line">				validateErrorHandler(true);</span><br><span class="line">				this.errorHandler = new LoggingErrorHandler();</span><br><span class="line">				// 如果没有errHandler，则会采用默认构造</span><br><span class="line">				this.batchErrorHandler = determineBatchErrorHandler(errHandler);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				validateErrorHandler(false);</span><br><span class="line">				// 如果没有errHandler，则会采用默认构造，这是单个消息的异常监听</span><br><span class="line">				this.errorHandler = determineErrorHandler(errHandler);</span><br><span class="line">				this.batchErrorHandler = new BatchLoggingErrorHandler();</span><br><span class="line">			&#125;</span><br><span class="line">			 </span><br><span class="line">// 以批量消费举例，默认异常构造</span><br><span class="line">		protected BatchErrorHandler determineBatchErrorHandler(GenericErrorHandler&lt;?&gt; errHandler) &#123;</span><br><span class="line">			return errHandler != null ? (BatchErrorHandler) errHandler</span><br><span class="line">					: this.transactionManager != null ? null : new RecoveringBatchErrorHandler();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">org.springframework.kafka.listener.RecoveringBatchErrorHandler#handle</span><br><span class="line">public void handle(Exception thrownException, ConsumerRecords&lt;?, ?&gt; data, Consumer&lt;?, ?&gt; consumer,</span><br><span class="line">			MessageListenerContainer container) &#123;</span><br><span class="line">		BatchListenerFailedException batchListenerFailedException = getBatchListenerFailedException(thrownException);</span><br><span class="line">		if (batchListenerFailedException == null) &#123;</span><br><span class="line">			this.logger.debug(thrownException, &quot;Expected a BatchListenerFailedException; re-seeking batch&quot;);</span><br><span class="line">			this.fallbackHandler.handle(thrownException, data, consumer, container);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">org.springframework.kafka.listener.SeekToCurrentBatchErrorHandler#handle</span><br><span class="line">	@Override</span><br><span class="line">	public void handle(Exception thrownException, ConsumerRecords&lt;?, ?&gt; data, Consumer&lt;?, ?&gt; consumer,</span><br><span class="line">			MessageListenerContainer container) &#123;</span><br><span class="line"></span><br><span class="line">		//异常处理，先seek到原来的位置</span><br><span class="line">		data.partitions()</span><br><span class="line">				.stream()</span><br><span class="line">				.collect(</span><br><span class="line">						Collectors.toMap(tp -&gt; tp,</span><br><span class="line">								tp -&gt; data.records(tp).get(0).offset(), (u, v) -&gt; (long) v, LinkedHashMap::new))</span><br><span class="line">				.forEach(consumer::seek);</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		//退避策略</span><br><span class="line">		if (this.backOff != null) &#123;</span><br><span class="line">			ListenerUtils.unrecoverableBackOff(this.backOff, this.backOffs, this.lastIntervals);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		throw new KafkaException(&quot;Seek to current after exception&quot;, getLogLevel(), thrownException);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p><a class="link"   target="_blank" rel="noopener" href="https://docs.spring.io/spring-kafka/docs/2.8.11/reference/html/#message-listener-container" >https://docs.spring.io/spring-kafka/docs/2.8.11/reference/html/#message-listener-container<i class="fas fa-external-link-alt"></i></a></p>
<p>2.3版本之后，提供了nack方法，阻塞后，可以休眠一段时间后重试，后续的消息并不会接收，会阻塞在那个分区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@KafkaListener(topics = &quot;bid-uc-6&quot;,</span><br><span class="line">        groupId = &quot;tmp&quot;,</span><br><span class="line">        containerFactory = &quot;kafkaContainerFactory&quot;, properties = &#123;&quot;max.poll.records:1&quot;&#125;)</span><br><span class="line">public void test(List&lt;ConsumerRecord&lt;String, String&gt;&gt; records, Acknowledgment acknowledgment) &#123;</span><br><span class="line">    for (ConsumerRecord&lt;String, String&gt; record : records) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            System.out.println(&quot;项目2收到消息：&quot; + record.value());</span><br><span class="line">                    </span><br><span class="line">        		//提交</span><br><span class="line">            acknowledgment.acknowledge();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            // 阻塞，1s后重试</span><br><span class="line">            acknowledgment.nack(0,1000);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看topic详情，调整partitions到3（提前设置好partitions）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --zookeeper localhost:2181 --describe --topic bid-uc</span><br><span class="line">./kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group saas-mcloud-cdp-bid-uc-tag-core</span><br><span class="line">./kafka-topics.sh --zookeeper localhost:2181 --alter --topic bid-uc --partitions 3</span><br></pre></td></tr></table></figure>

<ul>
<li>发送消息</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-producer.sh --broker-list localhost:9092  --topic bid-uc 123</span><br></pre></td></tr></table></figure>

<p>当topic已经创建后，partitions调整到3，等待一段时间后，kafka会自动重新分配。</p>
<ul>
<li>根据时间重放消息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. 定义消费者</span></span><br><span class="line">Map&lt;String, Object&gt; props = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, IntegerDeserializer.class);</span><br><span class="line">props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);</span><br><span class="line"><span class="comment">//消费组名</span></span><br><span class="line">props.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">&quot;aaaa123&quot;</span>);</span><br><span class="line"><span class="comment">//取消自动提交</span></span><br><span class="line">props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class="literal">true</span>);</span><br><span class="line"><span class="comment">//批量消费数量</span></span><br><span class="line">props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="number">10</span>);</span><br><span class="line"><span class="comment">//批量消费数量</span></span><br><span class="line">props.put(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG, <span class="number">2000</span>);</span><br><span class="line"><span class="comment">//重置策略</span></span><br><span class="line">props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">&quot;latest&quot;</span>);</span><br><span class="line"></span><br><span class="line">String topicName=<span class="string">&quot;tmp-offset&quot;</span>;</span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line"><span class="type">KafkaConsumer</span> <span class="variable">kafkaConsumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">KafkaConsumer</span>(props);</span><br><span class="line">kafkaConsumer.subscribe(Arrays.asList(topicName));</span><br><span class="line"></span><br><span class="line"><span class="comment">//等待重分配后，保证kafkaConsumer.assignment()有值</span></span><br><span class="line"><span class="keyword">while</span> (kafkaConsumer.assignment().isEmpty()) &#123;</span><br><span class="line">  kafkaConsumer.poll(Duration.ofMillis(<span class="number">100</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定时间点</span></span><br><span class="line"><span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> LocalDateTime.of(<span class="number">2023</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">19</span>, <span class="number">29</span>).</span><br><span class="line">  toInstant(ZoneOffset.ofHours(<span class="number">8</span>)).toEpochMilli();</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过通过seek重定位到待消费的地方</span></span><br><span class="line">Map&lt;TopicPartition, Long&gt; timeToSearch = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">Set&lt;TopicPartition&gt; assignment = kafkaConsumer.assignment();</span><br><span class="line"><span class="keyword">for</span> (TopicPartition topicPartition : assignment) &#123;</span><br><span class="line">  timeToSearch.put(topicPartition, startTime);</span><br><span class="line">&#125;</span><br><span class="line">Map&lt;TopicPartition, OffsetAndTimestamp&gt; map = kafkaConsumer.offsetsForTimes(timeToSearch);</span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;TopicPartition, OffsetAndTimestamp&gt; entry : map.entrySet()) &#123;</span><br><span class="line">  System.out.println(<span class="string">&quot;entry.getValue().offset()=&quot;</span>+entry.getValue().offset());</span><br><span class="line">  kafkaConsumer.seek(entry.getKey(), entry.getValue().offset());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开始消费</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  ConsumerRecords&lt;String, String&gt; records = kafkaConsumer.poll(Duration.ofMillis(<span class="number">100</span>));</span><br><span class="line">  <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;</span><br><span class="line">    System.out.printf(<span class="string">&quot;消费到消息 partition = %d, offset = %d, key = %s, value = %s%n&quot;</span>, record.partition(),record.offset(), record.key(), record.value());</span><br><span class="line">  &#125;</span><br><span class="line">  Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><h2 id="Offset为什么会中间不连续"><a href="#Offset为什么会中间不连续" class="headerlink" title="Offset为什么会中间不连续"></a>Offset为什么会中间不连续</h2><p>大概率是启用了事务，开启事务时，Kafka会先提交消息，占用offset，但该消息并不被”读已提交隔离级别的”的消费者可见，直到再次发送方确定事务提交后，消费者才能看到该消息。</p>
<h2 id="如果本地没有提交偏移量，那下次拉取还能拉取到这个消息吗？"><a href="#如果本地没有提交偏移量，那下次拉取还能拉取到这个消息吗？" class="headerlink" title="如果本地没有提交偏移量，那下次拉取还能拉取到这个消息吗？"></a>如果本地没有提交偏移量，那下次拉取还能拉取到这个消息吗？</h2><blockquote>
<p>前提是，使用原生的KafkaClient，Spring-kafka消费者异常后并不会提交offset</p>
</blockquote>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>消费Kafka消费时，出现异常，此时不想提交偏移量，下次重新消费时再次消费。</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>严格来说，需要分为3种场景，简而言之，保险起见，可以调用seek方法，重置消费者的Subscription，确保能够再次拉取到消息</p>
<ul>
<li>a) 消费者客户端重启，此时由于<strong>Subscriptions重置</strong>，会从当前offset开始拉取，则下次拉取可以拉到旧消息；</li>
<li>b) 消费者未重启，消费线程报错，但恰好本轮poll时间结束，进入下一轮拉取，未提交偏移量，那在下一次拉取时，由于<strong>Subscriptitions会重置</strong>，依然可以拉取到旧消息；</li>
<li>c) 消费者未重启，消费线程报错，但依然在本轮poll内，由于消费者拉取时，缓存了Subscriptitions，不会重置，因此，会拉取到最新的消息。</li>
</ul>
<p>Fetch流程图</p>
<p><img  
                       lazyload
                       alt="image"
                       data-src="/3_Kafka/image7.png"
                        alt="image-20230228221535616"
                 ></p>
<p>源码流程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">org.apache.kafka.clients.consumer.KafkaConsumer#poll(org.apache.kafka.common.utils.Timer, boolean)</span><br><span class="line"></span><br><span class="line">private ConsumerRecords&lt;K, V&gt; poll(final Timer timer, final boolean includeMetadataInTimeout) &#123;</span><br><span class="line">        acquireAndEnsureOpen();</span><br><span class="line">        try &#123;</span><br><span class="line">            // 省略校验 </span><br><span class="line"></span><br><span class="line">            // poll for new data until the timeout expires</span><br><span class="line">            do &#123;</span><br><span class="line">                // 省略前置处理，updateAssignmentMetadataIfNeeded需要重点关注下，这里是缓存消费方偏移量的地方，通过定时拉取，获取每个topic，partition的当前offset（未提交的offset）</span><br><span class="line">                </span><br><span class="line">								// 拉取的核心方法</span><br><span class="line">                final Map&lt;TopicPartition, List&lt;ConsumerRecord&lt;K, V&gt;&gt;&gt; records = pollForFetches(timer);</span><br><span class="line">                if (!records.isEmpty()) &#123;</span><br><span class="line">                    // 省略拉取到消息的超时处理</span><br><span class="line"></span><br><span class="line">										// 返回结果</span><br><span class="line">                    return this.interceptors.onConsume(new ConsumerRecords&lt;&gt;(records));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; while (timer.notExpired());</span><br><span class="line"></span><br><span class="line">            return ConsumerRecords.empty();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    org.apache.kafka.clients.consumer.KafkaConsumer#pollForFetches</span><br><span class="line">    private Map&lt;TopicPartition, List&lt;ConsumerRecord&lt;K, V&gt;&gt;&gt; pollForFetches(Timer timer) &#123;</span><br><span class="line">        long pollTimeout = coordinator == null ? timer.remainingMs() :</span><br><span class="line">                Math.min(coordinator.timeToNextPoll(timer.currentTimeMs()), timer.remainingMs());</span><br><span class="line"></span><br><span class="line">        // 尝试获取拉取到的数据</span><br><span class="line">        final Map&lt;TopicPartition, List&lt;ConsumerRecord&lt;K, V&gt;&gt;&gt; records = fetcher.fetchedRecords();</span><br><span class="line">        if (!records.isEmpty()) &#123;</span><br><span class="line">            return records;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 发送拉取数据的请求</span><br><span class="line">        fetcher.sendFetches();</span><br><span class="line"></span><br><span class="line">        // 省略一堆看不懂的有关时间和的处理</span><br><span class="line"></span><br><span class="line">    		// 获取拉取的数据</span><br><span class="line">        return fetcher.fetchedRecords();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    org.apache.kafka.clients.consumer.internals.Fetcher#sendFetches</span><br><span class="line">    public synchronized int sendFetches() &#123;</span><br><span class="line">        // Update metrics in case there was an assignment change</span><br><span class="line">        sensors.maybeUpdateAssignment(subscriptions);</span><br><span class="line"></span><br><span class="line">        Map&lt;Node, FetchSessionHandler.FetchRequestData&gt; fetchRequestMap = prepareFetchRequests();</span><br><span class="line">        for (Map.Entry&lt;Node, FetchSessionHandler.FetchRequestData&gt; entry : fetchRequestMap.entrySet()) &#123;</span><br><span class="line">            // 省略 构造拉取数据请求</span><br><span class="line">            </span><br><span class="line">            // 发起客户端调用，拉取数据，返回Future对象</span><br><span class="line">            RequestFuture&lt;ClientResponse&gt; future = client.send(fetchTarget, request);</span><br><span class="line">          </span><br><span class="line">          	// 省略部分代码</span><br><span class="line">            this.nodesWithPendingFetchRequests.add(entry.getKey().id());</span><br><span class="line">            </span><br><span class="line">            // Future调用成功后回调</span><br><span class="line">            future.addListener(new RequestFutureListener&lt;ClientResponse&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void onSuccess(ClientResponse resp) &#123;</span><br><span class="line">                    synchronized (Fetcher.this) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">                            FetchResponse&lt;Records&gt; response = (FetchResponse&lt;Records&gt;) resp.responseBody();</span><br><span class="line">                            </span><br><span class="line">                        		// 省略拉取到数据的处理方法</span><br><span class="line">                            for (Map.Entry&lt;TopicPartition, FetchResponse.PartitionData&lt;Records&gt;&gt; entry : response.responseData().entrySet()) &#123;</span><br><span class="line">                                TopicPartition partition = entry.getKey();</span><br><span class="line">                                FetchRequest.PartitionData requestData = data.sessionPartitions().get(partition);</span><br><span class="line">                                if (requestData == null) &#123;</span><br><span class="line">                                	 // 省略未获取到数据的情况</span><br><span class="line">                                &#125; else &#123;</span><br><span class="line">                                    long fetchOffset = requestData.fetchOffset;</span><br><span class="line">                                    // 省略获取到数据的处理</span><br><span class="line">                                    </span><br><span class="line">                                    // 1. 重点，返回参数里，会根据请求参数，获取最新未完成提交的fetchOffset（情况1：消费方未提交offset时异常，那重启后，这里一般会返回未提交的最后一个位点，以便能够继续拉取消息，情况2：消费方已经启动了，但是offset落后集群，但是此时来了一条新数据，这里一般会返回最新的offset，因为请求参数里，携带的是最早的offset）</span><br><span class="line">                                    completedFetches.add(new CompletedFetch(partition, fetchOffset, fetchData, metricAggregator,</span><br><span class="line">                                            resp.requestHeader().apiVersion()));</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            sensors.fetchLatency.record(resp.requestLatencyMs());</span><br><span class="line">                        &#125; finally &#123;</span><br><span class="line">                            nodesWithPendingFetchRequests.remove(fetchTarget.id());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void onFailure(RuntimeException e) &#123;</span><br><span class="line">                    //省略失败处理</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        return fetchRequestMap.size();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    org.apache.kafka.clients.consumer.internals.Fetcher#fetchedRecords</span><br><span class="line">    public Map&lt;TopicPartition, List&lt;ConsumerRecord&lt;K, V&gt;&gt;&gt; fetchedRecords() &#123;</span><br><span class="line">        Map&lt;TopicPartition, List&lt;ConsumerRecord&lt;K, V&gt;&gt;&gt; fetched = new HashMap&lt;&gt;();</span><br><span class="line">        int recordsRemaining = maxPollRecords;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            while (recordsRemaining &gt; 0) &#123;</span><br><span class="line">                if (nextInLineRecords == null || nextInLineRecords.isFetched) &#123;</span><br><span class="line">                    CompletedFetch completedFetch = completedFetches.peek();</span><br><span class="line">                    if (completedFetch == null) break;</span><br><span class="line"></span><br><span class="line">                    try &#123;</span><br><span class="line">                    		// 2. 这里从已完成的拉取里面（completedFetch）获取构造获取下一次拉取的数据</span><br><span class="line">                        nextInLineRecords = parseCompletedFetch(completedFetch);</span><br><span class="line">                    &#125; catch (Exception e) &#123;</span><br><span class="line">                        // 省略异常处理</span><br><span class="line">                    &#125;</span><br><span class="line">                    //3. 获取完就移除completedFetch队头元素</span><br><span class="line">                    completedFetches.poll();</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                  	// 利用上一个if中构造的nextInLineRecords，解析nextInLineRecords，获取到这一批的数据</span><br><span class="line">                    List&lt;ConsumerRecord&lt;K, V&gt;&gt; records = fetchRecords(nextInLineRecords, recordsRemaining);</span><br><span class="line">                    TopicPartition partition = nextInLineRecords.partition;</span><br><span class="line">                    if (!records.isEmpty()) &#123;</span><br><span class="line">                        // 省略获取到数据的处理</span><br><span class="line">                        </span><br><span class="line">                        // 并继续尝试获取下一批</span><br><span class="line">                        recordsRemaining -= records.size();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (KafkaException e) &#123;</span><br><span class="line">            if (fetched.isEmpty())</span><br><span class="line">                throw e;</span><br><span class="line">        &#125;</span><br><span class="line">        return fetched;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    org.apache.kafka.clients.consumer.internals.Fetcher#fetchRecords</span><br><span class="line">    private List&lt;ConsumerRecord&lt;K, V&gt;&gt; fetchRecords(PartitionRecords partitionRecords, int maxRecords) &#123;</span><br><span class="line">        if (!subscriptions.isAssigned(partitionRecords.partition)) &#123;</span><br><span class="line">             // 省略</span><br><span class="line">        &#125; else if (!subscriptions.isFetchable(partitionRecords.partition)) &#123;</span><br><span class="line">            // 省略</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            SubscriptionState.FetchPosition position = subscriptions.position(partitionRecords.partition);</span><br><span class="line">            if (partitionRecords.nextFetchOffset == position.offset) &#123;</span><br><span class="line">								// 重点返回数据方法，该方法会更新partitionRecords的nextFetchOffset，不断拉取数据</span><br><span class="line">                List&lt;ConsumerRecord&lt;K, V&gt;&gt; partRecords = partitionRecords.fetchRecords(maxRecords);</span><br><span class="line"></span><br><span class="line">                if (partitionRecords.nextFetchOffset &gt; position.offset) &#123;</span><br><span class="line">                		// 如果新的下一段offset大于本地缓存的offset，则需要更新本地offset缓存</span><br><span class="line">                    SubscriptionState.FetchPosition nextPosition = new SubscriptionState.FetchPosition(</span><br><span class="line">                            partitionRecords.nextFetchOffset,</span><br><span class="line">                            partitionRecords.lastEpoch,</span><br><span class="line">                            position.currentLeader);</span><br><span class="line">                    log.trace(&quot;Returning fetched records at offset &#123;&#125; for assigned partition &#123;&#125; and update &quot; +</span><br><span class="line">                            &quot;position to &#123;&#125;&quot;, position, partitionRecords.partition, nextPosition);</span><br><span class="line">                    subscriptions.position(partitionRecords.partition, nextPosition);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // 省略更新其他数据</span><br><span class="line">                </span><br><span class="line">                // 返回拉取的数据对象</span><br><span class="line">                return partRecords;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 省略</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        partitionRecords.drain();</span><br><span class="line">        return emptyList();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="为什么Kafka服务端启动时报zookeeper连接不上"><a href="#为什么Kafka服务端启动时报zookeeper连接不上" class="headerlink" title="为什么Kafka服务端启动时报zookeeper连接不上"></a>为什么Kafka服务端启动时报zookeeper连接不上</h2><p>zookeeper 3.4.10，kafka 2.12-2.1.0，zookeeper启动是成功的，端口2181也是正常，kafka配置的也是2181端口，但启动时依然报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 启动命令</span><br><span class="line">bin/kafka-server-start.sh ../config/server.properties</span><br><span class="line"></span><br><span class="line"># 日志</span><br><span class="line"> WARN | Session 0x0 for server localhost/&lt;unresolved&gt;:2181, unexpected error, closing socket connection and attempting reconnect</span><br><span class="line">    java.lang.IllegalArgumentException: Unable to canonicalize address localhost/&lt;unresolved&gt;:2181 because it&#x27;s not resolvable</span><br><span class="line">        at org.apache.zookeeper.SaslServerPrincipal.getServerPrincipal(SaslServerPrincipal.java:65)</span><br></pre></td></tr></table></figure>

<p>是因为jdk版本过高导致无法识别，降低到14版本以下即可</p>
<h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>分两种方式</p>
<ul>
<li>原生Client，手动提交偏移量至上一个消费的消息位点，保证下次poll能够重新消费</li>
<li>Spring-kafka，使用nack拒绝本次提交</li>
</ul>
<h1 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h1><blockquote>
<p>监控的指标有很多，这里以监控消费偏移量作为示例，其他指标类似</p>
</blockquote>
<h2 id="指标来源"><a href="#指标来源" class="headerlink" title="指标来源"></a>指标来源</h2><p>数据有多种来源</p>
<ol>
<li>Kafka自带的命令行，需要进去集群环境</li>
<li>Kafka集群和消费者应用暴露的jmx指标，无第三方，且指标丰富</li>
<li>Kafka_exporter收集指标，第三方托管，使用起来方便</li>
</ol>
<h3 id="命令行-1"><a href="#命令行-1" class="headerlink" title="命令行"></a>命令行</h3><p>查看消费的消息，需要指定到消费分组，可以看到当前提交偏移量为1，lag&#x3D;2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ./kafka-consumer-groups.sh --bootstrap-server localhost:9092  --describe --group myGroup</span><br><span class="line"></span><br><span class="line">TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                     HOST            CLIENT-ID</span><br><span class="line">demo-topic      0          1               3               2               consumer-1-a86bbec5-c078-4f8e-864f-0a0b6b4717f6 /127.0.0.1      consumer-1</span><br></pre></td></tr></table></figure>



<h3 id="Jmx指标"><a href="#Jmx指标" class="headerlink" title="Jmx指标"></a>Jmx指标</h3><p>查看对应kafka版本暴露的jmx指标，这里使用的是kafka的2.1.0版本，<a class="link"   target="_blank" rel="noopener" href="https://kafka.apache.org/21/documentation.html#monitoring" >https://kafka.apache.org/21/documentation.html#monitoring<i class="fas fa-external-link-alt"></i></a></p>
<blockquote>
<p>需要注意的是，server在kafka集群端暴露，producer和consumer是在具体的实例上暴露</p>
</blockquote>
<p>服务端启动时，是需要暴露jmx端口的，这里需要改一下启动参数，修改kafka-server-start.sh文件，在开头增加参数，启动即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JMX_PORT=9581</span><br></pre></td></tr></table></figure>

<p>此时，使用jdk自带的jconsoles可以查看到对应mbean</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./Library/Java/JavaVirtualMachines/jdk-1.8.jdk/Contents/Home/bin/jconsole</span><br></pre></td></tr></table></figure>

<p>页面如下</p>
<p><img  
                       lazyload
                       alt="image"
                       data-src="/3_Kafka/image1.png"
                        alt="image-20230228221535616"
                 ></p>
<p>这里是消费者实例的jmx，可以看到消费过2个消息，但并不是lag！（没找到只通过jmx如何判断lag的方式）</p>
<p><img  
                       lazyload
                       alt="image"
                       data-src="/3_Kafka/image2.png"
                        alt="image-20230228221535616"
                 ></p>
<p>另外还有一点，如果要暴露到prometheus，由于jmx的格式不适应prometheus，prometheus提供了kafka的转换agent，地址为：</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/prometheus/jmx_exporter" >https://github.com/prometheus/jmx_exporter<i class="fas fa-external-link-alt"></i></a></p>
<p>放在kafka启动目录下，指定jmx暴露代理，修改kafka启动目录下的kafka-server-start.sh文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KAFKA_OPTS=<span class="string">&quot;-javaagent:/Users/weiqian/Documents/1_apache/apache-kafka-2.12-2.1.0/bin/jmx_prometheus_javaagent-0.17.0.jar=9990:/Users/weiqian/Documents/1_apache/apache-kafka-2.12-2.1.0/bin/jmx-kafka.yml&quot;</span></span><br></pre></td></tr></table></figure>

<p>其中jmx-kafka.yml是jmx_exporter提供的示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">lowercaseOutputName: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">rules:</span><br><span class="line"><span class="comment"># Special cases and very specific rules</span></span><br><span class="line">- pattern : kafka.server&lt;<span class="built_in">type</span>=(.+), name=(.+), clientId=(.+), topic=(.+), partition=(.*)&gt;&lt;&gt;Value</span><br><span class="line">  name: kafka_server_$1_<span class="variable">$2</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">  labels:</span><br><span class="line">    clientId: <span class="string">&quot;<span class="variable">$3</span>&quot;</span></span><br><span class="line">    topic: <span class="string">&quot;<span class="variable">$4</span>&quot;</span></span><br><span class="line">    partition: <span class="string">&quot;<span class="variable">$5</span>&quot;</span></span><br><span class="line">- pattern : kafka.server&lt;<span class="built_in">type</span>=(.+), name=(.+), clientId=(.+), brokerHost=(.+), brokerPort=(.+)&gt;&lt;&gt;Value</span><br><span class="line">  name: kafka_server_$1_<span class="variable">$2</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">  labels:</span><br><span class="line">    clientId: <span class="string">&quot;<span class="variable">$3</span>&quot;</span></span><br><span class="line">    broker: <span class="string">&quot;<span class="variable">$4</span>:<span class="variable">$5</span>&quot;</span></span><br><span class="line">- pattern : kafka.coordinator.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+)&gt;&lt;&gt;Value</span><br><span class="line">  name: kafka_coordinator_$1_$2_<span class="variable">$3</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generic per-second counters with 0-2 key/value pairs</span></span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+)PerSec\w*, (.+)=(.+), (.+)=(.+)&gt;&lt;&gt;Count</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3_total</span></span><br><span class="line">  <span class="built_in">type</span>: COUNTER</span><br><span class="line">  labels:</span><br><span class="line">    <span class="string">&quot;<span class="variable">$4</span>&quot;</span>: <span class="string">&quot;<span class="variable">$5</span>&quot;</span></span><br><span class="line">    <span class="string">&quot;<span class="variable">$6</span>&quot;</span>: <span class="string">&quot;<span class="variable">$7</span>&quot;</span></span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+)PerSec\w*, (.+)=(.+)&gt;&lt;&gt;Count</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3_total</span></span><br><span class="line">  <span class="built_in">type</span>: COUNTER</span><br><span class="line">  labels:</span><br><span class="line">    <span class="string">&quot;<span class="variable">$4</span>&quot;</span>: <span class="string">&quot;<span class="variable">$5</span>&quot;</span></span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+)PerSec\w*&gt;&lt;&gt;Count</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3_total</span></span><br><span class="line">  <span class="built_in">type</span>: COUNTER</span><br><span class="line"></span><br><span class="line"><span class="comment"># Quota specific rules</span></span><br><span class="line">- pattern: kafka.server&lt;<span class="built_in">type</span>=(.+), user=(.+), client-id=(.+)&gt;&lt;&gt;([a-z-]+)</span><br><span class="line">  name: kafka_server_quota_<span class="variable">$4</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">  labels:</span><br><span class="line">    resource: <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    user: <span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">    clientId: <span class="string">&quot;<span class="variable">$3</span>&quot;</span></span><br><span class="line">- pattern: kafka.server&lt;<span class="built_in">type</span>=(.+), client-id=(.+)&gt;&lt;&gt;([a-z-]+)</span><br><span class="line">  name: kafka_server_quota_<span class="variable">$3</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">  labels:</span><br><span class="line">    resource: <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    clientId: <span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">- pattern: kafka.server&lt;<span class="built_in">type</span>=(.+), user=(.+)&gt;&lt;&gt;([a-z-]+)</span><br><span class="line">  name: kafka_server_quota_<span class="variable">$3</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">  labels:</span><br><span class="line">    resource: <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    user: <span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generic gauges with 0-2 key/value pairs</span></span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+), (.+)=(.+), (.+)=(.+)&gt;&lt;&gt;Value</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">  labels:</span><br><span class="line">    <span class="string">&quot;<span class="variable">$4</span>&quot;</span>: <span class="string">&quot;<span class="variable">$5</span>&quot;</span></span><br><span class="line">    <span class="string">&quot;<span class="variable">$6</span>&quot;</span>: <span class="string">&quot;<span class="variable">$7</span>&quot;</span></span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+), (.+)=(.+)&gt;&lt;&gt;Value</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">  labels:</span><br><span class="line">    <span class="string">&quot;<span class="variable">$4</span>&quot;</span>: <span class="string">&quot;<span class="variable">$5</span>&quot;</span></span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+)&gt;&lt;&gt;Value</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line"></span><br><span class="line"><span class="comment"># Emulate Prometheus &#x27;Summary&#x27; metrics for the exported &#x27;Histogram&#x27;s.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that these are missing the &#x27;_sum&#x27; metric!</span></span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+), (.+)=(.+), (.+)=(.+)&gt;&lt;&gt;Count</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3_count</span></span><br><span class="line">  <span class="built_in">type</span>: COUNTER</span><br><span class="line">  labels:</span><br><span class="line">    <span class="string">&quot;<span class="variable">$4</span>&quot;</span>: <span class="string">&quot;<span class="variable">$5</span>&quot;</span></span><br><span class="line">    <span class="string">&quot;<span class="variable">$6</span>&quot;</span>: <span class="string">&quot;<span class="variable">$7</span>&quot;</span></span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+), (.+)=(.*), (.+)=(.+)&gt;&lt;&gt;(\d+)thPercentile</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">  labels:</span><br><span class="line">    <span class="string">&quot;<span class="variable">$4</span>&quot;</span>: <span class="string">&quot;<span class="variable">$5</span>&quot;</span></span><br><span class="line">    <span class="string">&quot;<span class="variable">$6</span>&quot;</span>: <span class="string">&quot;<span class="variable">$7</span>&quot;</span></span><br><span class="line">    quantile: <span class="string">&quot;0.<span class="variable">$8</span>&quot;</span></span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+), (.+)=(.+)&gt;&lt;&gt;Count</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3_count</span></span><br><span class="line">  <span class="built_in">type</span>: COUNTER</span><br><span class="line">  labels:</span><br><span class="line">    <span class="string">&quot;<span class="variable">$4</span>&quot;</span>: <span class="string">&quot;<span class="variable">$5</span>&quot;</span></span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+), (.+)=(.*)&gt;&lt;&gt;(\d+)thPercentile</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">  labels:</span><br><span class="line">    <span class="string">&quot;<span class="variable">$4</span>&quot;</span>: <span class="string">&quot;<span class="variable">$5</span>&quot;</span></span><br><span class="line">    quantile: <span class="string">&quot;0.<span class="variable">$6</span>&quot;</span></span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+)&gt;&lt;&gt;Count</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3_count</span></span><br><span class="line">  <span class="built_in">type</span>: COUNTER</span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+)&gt;&lt;&gt;(\d+)thPercentile</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">  labels:</span><br><span class="line">    quantile: <span class="string">&quot;0.<span class="variable">$4</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generic gauges for MeanRate Percent</span></span><br><span class="line"><span class="comment"># Ex) kafka.server&lt;type=KafkaRequestHandlerPool, name=RequestHandlerAvgIdlePercent&gt;&lt;&gt;MeanRate</span></span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+)Percent\w*&gt;&lt;&gt;MeanRate</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3_percent</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+)Percent\w*&gt;&lt;&gt;Value</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3_percent</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">- pattern: kafka.(\w+)&lt;<span class="built_in">type</span>=(.+), name=(.+)Percent\w*, (.+)=(.+)&gt;&lt;&gt;Value</span><br><span class="line">  name: kafka_$1_$2_<span class="variable">$3_percent</span></span><br><span class="line">  <span class="built_in">type</span>: GAUGE</span><br><span class="line">  labels:</span><br><span class="line">    <span class="string">&quot;<span class="variable">$4</span>&quot;</span>: <span class="string">&quot;<span class="variable">$5</span>&quot;</span></span><br></pre></td></tr></table></figure>





<h3 id="Kafka-Exporter"><a href="#Kafka-Exporter" class="headerlink" title="Kafka_Exporter"></a>Kafka_Exporter</h3><p>exporter的方式就比较简单了，直接启动kafka_exporter包，配置kafka的监听路径，地址：<a class="link"   target="_blank" rel="noopener" href="https://github.com/danielqsj/kafka_exporter" >https://github.com/danielqsj/kafka_exporter<i class="fas fa-external-link-alt"></i></a> 启动命令为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./kafka_exporter --kafka.server=localhost:9092</span><br><span class="line"></span><br><span class="line">I1015 16:13:40.495902   12383 kafka_exporter.go:800] Starting kafka_exporter (version=1.7.0, branch=HEAD, revision=7e840e81a0170375214e2c1e1dc7ce94aeff8712)</span><br><span class="line">I1015 16:13:40.501380   12383 kafka_exporter.go:971] Listening on HTTP :9308</span><br></pre></td></tr></table></figure>

<p>访问<a class="link"   target="_blank" rel="noopener" href="http://127.0.0.1:9308/metrics" >http://127.0.0.1:9308/metrics<i class="fas fa-external-link-alt"></i></a> 可以看到监控信息</p>
<p><img  
                       lazyload
                       alt="image"
                       data-src="/3_Kafka/image3.png"
                        alt="image-20230228221535616"
                 ></p>
<h2 id="展示"><a href="#展示" class="headerlink" title="展示"></a>展示</h2><p>直接采用常用的Prometheus+grafana，</p>
<h3 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h3><p>下载Prometheus安装包，官网如下：<a class="link"   target="_blank" rel="noopener" href="https://prometheus.io/docs/introduction/first_steps/" >https://prometheus.io/docs/introduction/first_steps/<i class="fas fa-external-link-alt"></i></a></p>
<p>需要配置相关的exporter的端口，这里参考官方文档即可，prometheus.yml如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my global config</span></span><br><span class="line">global:</span><br><span class="line">  scrape_interval: 15s <span class="comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span></span><br><span class="line">  evaluation_interval: 15s <span class="comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span></span><br><span class="line">  <span class="comment"># scrape_timeout is set to the global default (10s).</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="comment"># Here it&#x27;s Prometheus itself.</span></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: <span class="string">&quot;elasticsearch_exporter&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [<span class="string">&quot;localhost:9114&quot;</span>]</span><br><span class="line"></span><br><span class="line">  - job_name: <span class="string">&quot;kafka_jmx&quot;</span></span><br><span class="line">    metrics_path: /metrics</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [<span class="string">&#x27;127.0.0.1:9990&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  - job_name: <span class="string">&quot;kafka_export&quot;</span></span><br><span class="line">    metrics_path: /metrics</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [<span class="string">&#x27;127.0.0.1:9308&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./prometheus --config.file=prometheus.yml</span><br></pre></td></tr></table></figure>

<p>默认访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:9090/" >http://localhost:9090/<i class="fas fa-external-link-alt"></i></a></p>
<p><img  
                       lazyload
                       alt="image"
                       data-src="/3_Kafka/image4.png"
                        alt="image-20230228221535616"
                 ></p>
<h3 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h3><p>下载Grafana安装包，官网如下：<a class="link"   target="_blank" rel="noopener" href="https://grafana.com/docs/grafana/latest/getting-started/get-started-grafana-prometheus/" >https://grafana.com/docs/grafana/latest/getting-started/get-started-grafana-prometheus/<i class="fas fa-external-link-alt"></i></a></p>
<p>启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./grafana-server web</span><br></pre></td></tr></table></figure>

<p>访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:3000/" >http://localhost:3000/<i class="fas fa-external-link-alt"></i></a></p>
<p><img  
                       lazyload
                       alt="image"
                       data-src="/3_Kafka/image5.png"
                        alt="image-20230228221535616"
                 ></p>
<p>当然，这里的模板还是要借鉴一下神通广大的网友，自己配费劲，比如：<a class="link"   target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/7589-kafka-exporter-overview/" >https://grafana.com/grafana/dashboards/7589-kafka-exporter-overview/<i class="fas fa-external-link-alt"></i></a></p>
<p><img  
                       lazyload
                       alt="image"
                       data-src="/3_Kafka/image6.png"
                        alt="image-20230228221535616"
                 ></p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E7%BB%84%E4%BB%B6/">组件</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/3_Elasticsearch/"
                                   title="Elasticsearch"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Elasticsearch</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2_%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E5%91%BD%E4%BB%A4/"
                                   title="常用工具命令"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">常用工具命令</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="nav-text">命令行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-kafka"><span class="nav-text">spring-kafka</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-text">常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Offset%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E4%B8%AD%E9%97%B4%E4%B8%8D%E8%BF%9E%E7%BB%AD"><span class="nav-text">Offset为什么会中间不连续</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%9C%AC%E5%9C%B0%E6%B2%A1%E6%9C%89%E6%8F%90%E4%BA%A4%E5%81%8F%E7%A7%BB%E9%87%8F%EF%BC%8C%E9%82%A3%E4%B8%8B%E6%AC%A1%E6%8B%89%E5%8F%96%E8%BF%98%E8%83%BD%E6%8B%89%E5%8F%96%E5%88%B0%E8%BF%99%E4%B8%AA%E6%B6%88%E6%81%AF%E5%90%97%EF%BC%9F"><span class="nav-text">如果本地没有提交偏移量，那下次拉取还能拉取到这个消息吗？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-text">背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-text">分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88Kafka%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%97%B6%E6%8A%A5zookeeper%E8%BF%9E%E6%8E%A5%E4%B8%8D%E4%B8%8A"><span class="nav-text">为什么Kafka服务端启动时报zookeeper连接不上</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%B3%95"><span class="nav-text">解法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7"><span class="nav-text">监控</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E6%A0%87%E6%9D%A5%E6%BA%90"><span class="nav-text">指标来源</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C-1"><span class="nav-text">命令行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jmx%E6%8C%87%E6%A0%87"><span class="nav-text">Jmx指标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kafka-Exporter"><span class="nav-text">Kafka_Exporter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B1%95%E7%A4%BA"><span class="nav-text">展示</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Prometheus"><span class="nav-text">Prometheus</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Grafana"><span class="nav-text">Grafana</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2024
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">EmiyaQ</a>
        
    </div>

    <div class="theme-info info-item">
        由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;&&nbsp;主题&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="nav-text">命令行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spring-kafka"><span class="nav-text">spring-kafka</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-text">常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Offset%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E4%B8%AD%E9%97%B4%E4%B8%8D%E8%BF%9E%E7%BB%AD"><span class="nav-text">Offset为什么会中间不连续</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%9C%AC%E5%9C%B0%E6%B2%A1%E6%9C%89%E6%8F%90%E4%BA%A4%E5%81%8F%E7%A7%BB%E9%87%8F%EF%BC%8C%E9%82%A3%E4%B8%8B%E6%AC%A1%E6%8B%89%E5%8F%96%E8%BF%98%E8%83%BD%E6%8B%89%E5%8F%96%E5%88%B0%E8%BF%99%E4%B8%AA%E6%B6%88%E6%81%AF%E5%90%97%EF%BC%9F"><span class="nav-text">如果本地没有提交偏移量，那下次拉取还能拉取到这个消息吗？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-text">背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-text">分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88Kafka%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%90%AF%E5%8A%A8%E6%97%B6%E6%8A%A5zookeeper%E8%BF%9E%E6%8E%A5%E4%B8%8D%E4%B8%8A"><span class="nav-text">为什么Kafka服务端启动时报zookeeper连接不上</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%B3%95"><span class="nav-text">解法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7"><span class="nav-text">监控</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E6%A0%87%E6%9D%A5%E6%BA%90"><span class="nav-text">指标来源</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C-1"><span class="nav-text">命令行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jmx%E6%8C%87%E6%A0%87"><span class="nav-text">Jmx指标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kafka-Exporter"><span class="nav-text">Kafka_Exporter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B1%95%E7%A4%BA"><span class="nav-text">展示</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Prometheus"><span class="nav-text">Prometheus</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Grafana"><span class="nav-text">Grafana</span></a></li></ol></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->

    
<script src="/js/lazyload.js"></script>



<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
