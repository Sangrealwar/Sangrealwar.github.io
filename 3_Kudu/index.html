<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="人生，总有些黑暗的隧道需要自己穿越">
    <meta name="author" content="EmiyaQ">
    
    <title>
        
            Kudu |
        
        The winter sunshine
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/logo.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"sangrealwar.github.io","root":"/","language":"zh-CN","path":"search.xml"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"The winter sunshine","author":"EmiyaQ","avatar":"/images/pig.png","logo":"/images/logo.svg","favicon":"/images/logo.svg"},"menu":{"home":"/","archives":"/archives","categories":"/categories"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":null,"category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":false,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":true},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":false,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.3"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               The winter sunshine
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                分类
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                            分类
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Kudu
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/pig.png">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">EmiyaQ</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2023-02-28 22:13:53</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Sun Oct 20 2024 11:30:22 GMT+0800">2024-10-20 11:30:22</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BB%84%E4%BB%B6/">分布式组件</a></li>
                        
                    
                </ul>
            </span>
        

        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <meta name="referrer" content="no-referrer"/>



<blockquote>
<p>官网：<a class="link"   target="_blank" rel="noopener" href="https://kudu.apache.org/docs/" >https://kudu.apache.org/docs/<i class="fas fa-external-link-alt"></i></a></p>
<p>官网FAQ：<a class="link"   target="_blank" rel="noopener" href="https://kudu.apache.org/faq.html" >https://kudu.apache.org/faq.html<i class="fas fa-external-link-alt"></i></a></p>
<p>git：<a class="link"   target="_blank" rel="noopener" href="https://github.com/apache/kudu/tree/master/docs/design-docs" >https://github.com/apache/kudu/tree/master/docs/design-docs<i class="fas fa-external-link-alt"></i></a></p>
<p>变更历史：<a class="link"   target="_blank" rel="noopener" href="https://kudu.apache.org/blog/" >https://kudu.apache.org/blog/<i class="fas fa-external-link-alt"></i></a></p>
</blockquote>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Kudu是一款分布式，列式，OLAP的存储引擎。在OLAP负载下有着较快的处理速度，结构化数据模型，随机和顺序工作场景下的高性能，HDFS&#x2F;impala&#x2F;NiFi&#x2F;Spark&#x2F;hive等集成，健壮&#x2F;灵活的一致性模型，RPC加密解密，高可用（Raft），自动失败监测（失败分片自动转移到另一个tabletServer上），机架感知，多行事务，易于管理，逻辑备份。</p>
<img  
                       lazyload
                       alt="image"
                       data-src="/3_Kudu/2.png"
                        class="" title="image-20230228221535616"
                 >

<p>​																						Kudu网络架构（来自官网）</p>
<h2 id="Docker本地安装"><a href="#Docker本地安装" class="headerlink" title="Docker本地安装"></a>Docker本地安装</h2><ul>
<li>下载git源码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/apache/kudu</span><br><span class="line">cd kudu</span><br></pre></td></tr></table></figure>

<ul>
<li>暴露kudu ip</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUDU_QUICKSTART_IP=$(ifconfig | grep <span class="string">&quot;inet &quot;</span> | grep -Fv 127.0.0.1 |  awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="built_in">tail</span> -1)</span><br></pre></td></tr></table></figure>

<ul>
<li>调整kudu版本</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUDU_QUICKSTART_VERSION=<span class="string">&quot;1.12.0&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>启动集群，-d表示后台运行，官网会启动5个tablet server（测试用3个tablet server），3个master节点，启动后<a class="link"   target="_blank" rel="noopener" href="http://localhost:8050/tablets" >http://localhost:8050/tablets<i class="fas fa-external-link-alt"></i></a> Ui界面可以查看集群情况</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f quickstart.yml up -d</span><br></pre></td></tr></table></figure>

<ul>
<li>测试运行</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUDU_USER_NAME=kudu</span><br><span class="line"><span class="built_in">cd</span> examples/java/java-example</span><br><span class="line">mvn package</span><br><span class="line">java -DkuduMasters=localhost:7051,localhost:7151,localhost:7251 -jar target/kudu-java-example-1.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure>

<ul>
<li>查看日志</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs $(docker ps -aqf <span class="string">&quot;name=kudu-tserver-1&quot;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f quickstart.yml down</span><br><span class="line">docker stop $(docker ps -aqf <span class="string">&quot;name=kudu&quot;</span>)</span><br><span class="line">docker <span class="built_in">rm</span> $(docker ps -aqf <span class="string">&quot;name=kudu&quot;</span>)</span><br><span class="line">docker volume <span class="built_in">rm</span> $(docker volume <span class="built_in">ls</span> --filter name=kudu -q)</span><br></pre></td></tr></table></figure>





<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><h2 id="Tablet"><a href="#Tablet" class="headerlink" title="Tablet"></a>Tablet</h2><p>Tablet刷新过程（来自官网）</p>
<img  
                       lazyload
                       alt="image"
                       data-src="/3_Kudu/4.png"
                        class=""
                 >

<p>小结（来自官网）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">+-----------+</span><br><span class="line">| MemRowSet |</span><br><span class="line">+-----------+</span><br><span class="line">  |</span><br><span class="line">  | flush: creates a new DiskRowSet 0</span><br><span class="line">  v</span><br><span class="line">+---------------+</span><br><span class="line">| DiskRowSet 0  |</span><br><span class="line">+---------------+</span><br><span class="line"></span><br><span class="line">DiskRowSet 1:</span><br><span class="line">+---------+     +------------+      +---------+     +---------+     +---------+     +---------+</span><br><span class="line">| UNDOs 0 | --&gt; | base data  | &lt;--- | REDOs 0 | &lt;-- | REDOS 1 | &lt;-- | REDOs 2 | &lt;-- | REDOs 3 |</span><br><span class="line">+---------+     +------------+      +---------+     +---------+     +---------+     +---------+</span><br><span class="line">\____________________________________________________________/</span><br><span class="line">                           | major compaction</span><br><span class="line">                           v</span><br><span class="line"></span><br><span class="line">+---------+     +------------+      +---------+     +---------+</span><br><span class="line">| UNDOs 0&#x27;| --&gt; | base data&#x27; | &lt;--- | REDOs 2 | &lt;-- | REDOs 3 |</span><br><span class="line">+---------+     +------------+      +---------+     +---------+</span><br><span class="line">\____________________________/</span><br><span class="line">      compaction result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DiskRowSet 2:</span><br><span class="line">+---------+     +------------+      +---------+     +---------+     +---------+     +---------+</span><br><span class="line">| UNDOs 0 | --&gt; | base data  | &lt;--- | REDOs 0 | &lt;-- | REDOS 1 | &lt;-- | REDOs 2 | &lt;-- | REDOs 3 |</span><br><span class="line">+---------+     +------------+      +---------+     +---------+     +---------+     +---------+</span><br><span class="line">                                    \_________________________/</span><br><span class="line">                                         | minor compaction</span><br><span class="line">                                         v</span><br><span class="line">+---------+     +------------+      +---------+      +---------+     +---------+</span><br><span class="line">| UNDOs 0 | --&gt; | base data  | &lt;--- | REDOS 0&#x27;|  &lt;-- | REDOs 2 | &lt;-- | REDOs 3 |</span><br><span class="line">+---------+     +------------+      +---------+      +---------+     +---------+</span><br><span class="line">                                    \_________/</span><br><span class="line">                                 compaction result</span><br><span class="line"></span><br><span class="line">+-----------------+ \</span><br><span class="line">| DiskRowSet 3    | |</span><br><span class="line">+-----------------+ |</span><br><span class="line">                    |</span><br><span class="line">+-----------------+ |                              +----------------+</span><br><span class="line">| DiskRowSet 4    | |===&gt; Merging compaction ===&gt;  | new DiskRowSet |</span><br><span class="line">+-----------------+ |                              +----------------+</span><br><span class="line">                    |</span><br><span class="line">+-----------------+ |</span><br><span class="line">| DiskRowSet 5    | |</span><br><span class="line">+-----------------+ /</span><br></pre></td></tr></table></figure>





<ul>
<li>主要读取操作</li>
</ul>
<blockquote>
<p>通过各种迭代器，从内存和磁盘中读取相关数据，这里的迭代器各种封装，最终磁盘底层由CFile或DeltaTracker检索，内存检索BTree，并结合去重，合并，谓词下推，Key范围剪枝等迭代器进行优化，最终返回数据</p>
</blockquote>
<img  
                       lazyload
                       alt="image"
                       data-src="/3_Kudu/5.png"
                        class=""
                 >

<ul>
<li>主要写入操作</li>
</ul>
<blockquote>
<ol>
<li>插入和部分更新删除（MemRowSet未flush到磁盘时），会写入到MemRowSet，MemRowSet是BTree结构；</li>
<li>当MemRowSet超过一定大小后，会溢写到磁盘，形成BaseFile（CFile），一个RowSet也包含多行记录，按rowid排序。同时会保留UndoFile；</li>
<li>BaseFile和RedoFIle会触发Major Compact，减少DeltaFile数量。较早的UndoFile会因为时间较久而被清理</li>
<li>大部分更新删除操作会写入Delta MemStore，也是一个BTree结构；</li>
<li>当Memstore超过一定大小，会溢写到磁盘，形成RedoFile（CFile）；</li>
<li>部分RedoFile会频繁执行小范围的 Minor Compact，减少DeltaFile数量；</li>
<li>多个DiskRowSet会触发Merge Compact，减少重复的主键Key的重叠率。</li>
</ol>
</blockquote>
<img  
                       lazyload
                       alt="image"
                       data-src="/3_Kudu/3.png"
                        class="" title="image-20230228221535616"
                 >





<h2 id="查询加速"><a href="#查询加速" class="headerlink" title="查询加速"></a>查询加速</h2><h3 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h3><p>Hase</p>
<p>Range</p>
<p>混合</p>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><p>主键索引</p>
<p>跳表索引（Skip Scan Index）</p>
<h1 id="源码阅读"><a href="#源码阅读" class="headerlink" title="源码阅读"></a>源码阅读</h1><p>Kudu读取过程</p>
<ol>
<li>Tablet的rowset结构</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct TabletComponents : public RefCountedThreadSafe&lt;TabletComponents&gt; &#123;</span><br><span class="line">  TabletComponents(std::shared_ptr&lt;MemRowSet&gt; mrs,</span><br><span class="line">                   std::vector&lt;std::shared_ptr&lt;MemRowSet&gt;&gt; txn_mrss,</span><br><span class="line">                   std::shared_ptr&lt;RowSetTree&gt; rs_tree);</span><br><span class="line">  // The &quot;main&quot; MemRowSet that catches inserts to the tablet that are not a</span><br><span class="line">  // part of any transaction.</span><br><span class="line">  const std::shared_ptr&lt;MemRowSet&gt; memrowset;</span><br><span class="line"></span><br><span class="line">  // MemRowSets whose insertion heads were inserted as a part of a transaction.</span><br><span class="line">  const std::vector&lt;std::shared_ptr&lt;MemRowSet&gt;&gt; txn_memrowsets;</span><br><span class="line"></span><br><span class="line">  // The persisted RowSets that comprise the rows of a tablet.</span><br><span class="line">  const std::shared_ptr&lt;RowSetTree&gt; rowsets;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>主要类结构图</li>
</ol>
<p><img  
                       lazyload
                       alt="image"
                       data-src="/Users/weiqian/Documents/3_study/hexo/source/_posts/3_Kudu%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/1.png"
                        alt="image-202306"
                 ></p>
<ol start="3">
<li>代码流程</li>
</ol>
<p>C++暴露的Scan接口，由JavaClient的org.apache.kudu.client.AsyncKuduClient#sendRpcToTablet发出RPC请求，扫描数据，kudu服务器接受请求的是kudu.tserver.TabletServerService的Scan（中间经过RPC层中转）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">org.apache.kudu.client.AsyncKuduScanner#nextRows</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Deferred&lt;RowResultIterator&gt; <span class="title function_">nextRows</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (closed) &#123;  <span class="comment">// We&#x27;re already done scanning.</span></span><br><span class="line">      <span class="keyword">if</span> (prefetching &amp;&amp; cachedPrefetcherDeferred.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// return the cached result and reset the cache.</span></span><br><span class="line">        <span class="keyword">return</span> cachedPrefetcherDeferred.getAndUpdate((v) -&gt; <span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> Deferred.fromResult(<span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tablet == <span class="literal">null</span>) &#123;</span><br><span class="line">      Callback&lt;Deferred&lt;RowResultIterator&gt;, AsyncKuduScanner.Response&gt; cb =</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">Callback</span>&lt;Deferred&lt;RowResultIterator&gt;, Response&gt;() &#123;</span><br><span class="line">         ...</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      Callback&lt;Deferred&lt;RowResultIterator&gt;, Exception&gt; eb =</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">Callback</span>&lt;Deferred&lt;RowResultIterator&gt;, Exception&gt;() &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 发起请求</span></span><br><span class="line">      <span class="keyword">return</span> client.sendRpcToTablet(getOpenRequest()).addCallbackDeferring(cb).addErrback(eb);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prefetching &amp;&amp; cachedPrefetcherDeferred.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> Deferred&lt;RowResultIterator&gt; d =</span><br><span class="line">        client.scanNextRows(<span class="built_in">this</span>).addCallbacks(gotNextRow, nextRowErrback());</span><br><span class="line">    <span class="keyword">if</span> (prefetching) &#123;</span><br><span class="line">      d.chain(<span class="keyword">new</span> <span class="title class_">Deferred</span>&lt;RowResultIterator&gt;().addCallback(prefetch));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> d;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>KuduServer（C++），1.17版本</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TabletServiceImpl::Scan</span><span class="params">(<span class="type">const</span> ScanRequestPB* req,</span></span></span><br><span class="line"><span class="params"><span class="function">                             ScanResponsePB* resp,</span></span></span><br><span class="line"><span class="params"><span class="function">                             RpcContext* context)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">TRACE_EVENT0</span>(<span class="string">&quot;tserver&quot;</span>, <span class="string">&quot;TabletServiceImpl::Scan&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check 第一次读取数据，或者第二次读取</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">PREDICT_FALSE</span>(req-&gt;<span class="built_in">has_scanner_id</span>() &amp;&amp;</span><br><span class="line">                    req-&gt;<span class="built_in">has_new_scan_request</span>())) &#123;</span><br><span class="line">    context-&gt;<span class="built_in">RespondFailure</span>(Status::<span class="built_in">InvalidArgument</span>(</span><br><span class="line">                            <span class="string">&quot;Must not pass both a scanner_id and new_scan_request&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证是否有权限</span></span><br><span class="line">  TokenPB token;</span><br><span class="line">  <span class="keyword">if</span> (FLAGS_tserver_enforce_access_control &amp;&amp; req-&gt;<span class="built_in">has_new_scan_request</span>()) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; scan_pb = req-&gt;<span class="built_in">new_scan_request</span>();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">VerifyAuthzTokenOrRespond</span>(server_-&gt;<span class="built_in">token_verifier</span>(),</span><br><span class="line">                                   req-&gt;<span class="built_in">new_scan_request</span>(), context, &amp;token)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    scoped_refptr&lt;TabletReplica&gt; replica;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">LookupRunningTabletReplicaOrRespond</span>(server_-&gt;<span class="built_in">tablet_manager</span>(),</span><br><span class="line">        req-&gt;<span class="built_in">new_scan_request</span>().<span class="built_in">tablet_id</span>(), resp, context, &amp;replica)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; privilege = token.<span class="built_in">authz</span>().<span class="built_in">table_privilege</span>();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CheckMatchingTableIdOrRespond</span>(privilege, replica-&gt;<span class="built_in">tablet_metadata</span>()-&gt;<span class="built_in">table_id</span>(),</span><br><span class="line">                                       <span class="string">&quot;Scan&quot;</span>, context)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    unordered_set&lt;ColumnId&gt; authorized_column_ids;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CheckMayHaveScanPrivilegesOrRespond</span>(privilege, <span class="string">&quot;Scan&quot;</span>, &amp;authorized_column_ids, context)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If the token doesn&#x27;t have full scan privileges for the table, check</span></span><br><span class="line">    <span class="comment">// for required privileges based on the scan request.</span></span><br><span class="line">    <span class="keyword">if</span> (!privilege.<span class="built_in">scan_privilege</span>()) &#123;</span><br><span class="line">      <span class="type">const</span> SchemaPtr schema_ptr = replica-&gt;<span class="built_in">tablet_metadata</span>()-&gt;<span class="built_in">schema</span>();</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">CheckScanPrivilegesOrRespond</span>(scan_pb, *schema_ptr, authorized_column_ids,</span><br><span class="line">                                        <span class="string">&quot;Scan&quot;</span>, context)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//开始读数据</span></span><br><span class="line">  <span class="function">ScanResultCopier <span class="title">collector</span><span class="params">(GetMaxBatchSizeBytesHint(req))</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> has_more_results = <span class="literal">false</span>;</span><br><span class="line">  TabletServerErrorPB::Code error_code = TabletServerErrorPB::UNKNOWN_ERROR;</span><br><span class="line">  <span class="keyword">if</span> (req-&gt;<span class="built_in">has_new_scan_request</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CheckTabletServerNotQuiescingOrRespond</span>(server_, resp, context)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> NewScanRequestPB&amp; scan_pb = req-&gt;<span class="built_in">new_scan_request</span>();</span><br><span class="line">    scoped_refptr&lt;TabletReplica&gt; replica;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">LookupRunningTabletReplicaOrRespond</span>(server_-&gt;<span class="built_in">tablet_manager</span>(), scan_pb.<span class="built_in">tablet_id</span>(), resp,</span><br><span class="line">                                             context, &amp;replica)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    string scanner_id;</span><br><span class="line">    Timestamp scan_timestamp;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//开始读取数据，并记录scanner_id</span></span><br><span class="line">    Status s = <span class="built_in">HandleNewScanRequest</span>(replica.<span class="built_in">get</span>(), req, context,</span><br><span class="line">                                    &amp;collector, &amp;scanner_id, &amp;scan_timestamp, &amp;has_more_results,</span><br><span class="line">                                    &amp;error_code);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PREDICT_FALSE</span>(!s.<span class="built_in">ok</span>())) &#123;</span><br><span class="line">      <span class="built_in">SetupErrorAndRespond</span>(resp-&gt;<span class="built_in">mutable_error</span>(), s, error_code, context);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only set the scanner id if we have more results.</span></span><br><span class="line">    <span class="keyword">if</span> (has_more_results) &#123;</span><br><span class="line">      resp-&gt;<span class="built_in">set_scanner_id</span>(scanner_id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (scan_timestamp != Timestamp::kInvalidTimestamp) &#123;</span><br><span class="line">      resp-&gt;<span class="built_in">set_snap_timestamp</span>(scan_timestamp.<span class="built_in">ToUint64</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req-&gt;<span class="built_in">has_scanner_id</span>()) &#123;</span><br><span class="line">    <span class="comment">//继续读取数据</span></span><br><span class="line">    Status s = <span class="built_in">HandleContinueScanRequest</span>(req, context, &amp;collector, &amp;has_more_results, &amp;error_code);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PREDICT_FALSE</span>(!s.<span class="built_in">ok</span>())) &#123;</span><br><span class="line">      <span class="built_in">SetupErrorAndRespond</span>(resp-&gt;<span class="built_in">mutable_error</span>(), s, error_code, context);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    context-&gt;<span class="built_in">RespondFailure</span>(Status::<span class="built_in">InvalidArgument</span>(</span><br><span class="line">                              <span class="string">&quot;Must pass either a scanner_id or new_scan_request&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  collector.<span class="built_in">SetupResponse</span>(context, resp);</span><br><span class="line">  resp-&gt;<span class="built_in">set_has_more_results</span>(has_more_results);</span><br><span class="line">  resp-&gt;<span class="built_in">set_propagated_timestamp</span>(server_-&gt;<span class="built_in">clock</span>()-&gt;<span class="built_in">Now</span>().<span class="built_in">ToUint64</span>());</span><br><span class="line"></span><br><span class="line">  <span class="built_in">SetResourceMetrics</span>(context, collector.<span class="built_in">cpu_times</span>(), resp-&gt;<span class="built_in">mutable_resource_metrics</span>());</span><br><span class="line">  context-&gt;<span class="built_in">RespondSuccess</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一次读取</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">TabletServiceImpl::HandleNewScanRequest</span><span class="params">(TabletReplica* replica,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="type">const</span> ScanRequestPB* req,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="type">const</span> RpcContext* rpc_context,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               ScanResultCollector* result_collector,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               string* scanner_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               Timestamp* snap_timestamp,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="type">bool</span>* has_more_results,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               TabletServerErrorPB::Code* error_code)</span> </span>&#123;</span><br><span class="line">  ... 省略了一波操作</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//初始化RowwiseIterator迭代器</span></span><br><span class="line">  unique_ptr&lt;RowwiseIterator&gt; iter;</span><br><span class="line">  optional&lt;Timestamp&gt; snap_start_timestamp;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;Creating iterator&quot;</span>);</span><br><span class="line">    <span class="built_in">TRACE_EVENT0</span>(<span class="string">&quot;tserver&quot;</span>, <span class="string">&quot;Create iterator&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (scan_pb.<span class="built_in">read_mode</span>()) &#123;</span><br><span class="line">      <span class="keyword">case</span> UNKNOWN_READ_MODE: &#123;</span><br><span class="line">        *error_code = TabletServerErrorPB::INVALID_SCAN_SPEC;</span><br><span class="line">        <span class="keyword">return</span> Status::<span class="built_in">NotSupported</span>(<span class="string">&quot;Unknown read mode.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> READ_LATEST: &#123;</span><br><span class="line">        <span class="keyword">if</span> (scan_pb.<span class="built_in">has_snap_start_timestamp</span>()) &#123;</span><br><span class="line">          *error_code = TabletServerErrorPB::INVALID_SCAN_SPEC;</span><br><span class="line">          <span class="keyword">return</span> Status::<span class="built_in">InvalidArgument</span>(<span class="string">&quot;scan start timestamp is only supported &quot;</span></span><br><span class="line">                                         <span class="string">&quot;in READ_AT_SNAPSHOT read mode&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//通过tablet初始化RowIterator器</span></span><br><span class="line">        s = tablet-&gt;<span class="built_in">NewRowIterator</span>(projection, &amp;iter);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> READ_YOUR_WRITES: <span class="comment">// Fallthrough intended</span></span><br><span class="line">      <span class="keyword">case</span> READ_AT_SNAPSHOT: &#123;</span><br><span class="line">        s = <span class="built_in">HandleScanAtSnapshot</span>(</span><br><span class="line">            scan_pb, rpc_context, projection, tablet.<span class="built_in">get</span>(), replica-&gt;<span class="built_in">time_manager</span>(),</span><br><span class="line">            &amp;iter, &amp;snap_start_timestamp, snap_timestamp, error_code);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;Iterator created&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	 <span class="comment">//省略一堆</span></span><br><span class="line">	 </span><br><span class="line">  scanner-&gt;<span class="built_in">Init</span>(std::<span class="built_in">move</span>(iter), std::<span class="built_in">move</span>(orig_spec), std::<span class="built_in">move</span>(client_projection));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Stop the scanner timer because ContinueScanRequest starts its own timer.</span></span><br><span class="line">  scanner_timer.<span class="built_in">Stop</span>();</span><br><span class="line">  unreg_scanner.<span class="built_in">Cancel</span>();</span><br><span class="line">  *scanner_id = scanner-&gt;<span class="built_in">id</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">VLOG</span>(<span class="number">1</span>) &lt;&lt; <span class="string">&quot;Started scanner &quot;</span> &lt;&lt; scanner-&gt;<span class="built_in">id</span>() &lt;&lt; <span class="string">&quot;: &quot;</span> &lt;&lt; scanner-&gt;<span class="built_in">iter</span>()-&gt;<span class="built_in">ToString</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">GetMaxBatchSizeBytesHint</span>(req) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">TRACE</span>(<span class="string">&quot;Continuing scan request&quot;</span>);</span><br><span class="line">    <span class="comment">// TODO(wdberkeley): Instead of copying the pb, instead split</span></span><br><span class="line">    <span class="comment">// HandleContinueScanRequest and call the second half directly. Once that&#x27;s</span></span><br><span class="line">    <span class="comment">// done, remove the call to ScopedAddScannerTiming::Stop() above (and the</span></span><br><span class="line">    <span class="comment">// method as it won&#x27;t be used) and start the timing for continue requests</span></span><br><span class="line">    <span class="comment">// from the first half that is no longer executed in this codepath.</span></span><br><span class="line">    <span class="function">ScanRequestPB <span class="title">continue_req</span><span class="params">(*req)</span></span>;</span><br><span class="line">    continue_req.<span class="built_in">set_scanner_id</span>(scanner-&gt;<span class="built_in">id</span>());</span><br><span class="line">    scanner_lock.<span class="built_in">Unlock</span>();</span><br><span class="line">    <span class="comment">//初始化好了scanRequest，开始扫描</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">HandleContinueScanRequest</span>(</span><br><span class="line">        &amp;continue_req, rpc_context, result_collector, has_more_results, error_code);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Increment the scanner call sequence ID. HandleContinueScanRequest handles</span></span><br><span class="line">  <span class="comment">// this in the non-empty scan case.</span></span><br><span class="line">  scanner-&gt;<span class="built_in">IncrementCallSeqId</span>();</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是读取历史的，和上面代码类似</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">TabletServiceImpl::HandleContinueScanRequest</span><span class="params">(<span class="type">const</span> ScanRequestPB* req,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    <span class="type">const</span> RpcContext* rpc_context,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    ScanResultCollector* result_collector,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    <span class="type">bool</span>* has_more_results,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    TabletServerErrorPB::Code* error_code)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//省略</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//获取scan</span></span><br><span class="line">  <span class="type">size_t</span> batch_size_bytes = <span class="built_in">GetMaxBatchSizeBytesHint</span>(req);</span><br><span class="line"></span><br><span class="line">  SharedScanner scanner;</span><br><span class="line">  TabletServerErrorPB::Code code = TabletServerErrorPB::UNKNOWN_ERROR;</span><br><span class="line">  Status s = server_-&gt;<span class="built_in">scanner_manager</span>()-&gt;<span class="built_in">LookupScanner</span>(req-&gt;<span class="built_in">scanner_id</span>(),</span><br><span class="line">                                                       rpc_context-&gt;<span class="built_in">remote_user</span>().<span class="built_in">username</span>(),</span><br><span class="line">                                                       &amp;code,</span><br><span class="line">                                                       &amp;scanner);</span><br><span class="line">  <span class="comment">//省略</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//获取迭代读取器</span></span><br><span class="line">  RowwiseIterator* iter = scanner-&gt;<span class="built_in">iter</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the row format flags on the ScanResultCollector.</span></span><br><span class="line">  s = result_collector-&gt;<span class="built_in">InitSerializer</span>(scanner-&gt;<span class="built_in">row_format_flags</span>(),</span><br><span class="line">                                       iter-&gt;<span class="built_in">schema</span>(),</span><br><span class="line">                                       *scanner-&gt;<span class="built_in">client_projection_schema</span>());</span><br><span class="line">  <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    *error_code = TabletServerErrorPB::INVALID_SCAN_SPEC;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO(todd): could size the RowBlock based on the user&#x27;s requested batch size?</span></span><br><span class="line">  <span class="comment">// If people had really large indirect objects, we would currently overshoot</span></span><br><span class="line">  <span class="comment">// their requested batch size by a lot.</span></span><br><span class="line">  <span class="function">RowBlockMemory <span class="title">mem</span><span class="params">(<span class="number">32</span> * <span class="number">1024</span>)</span></span>;</span><br><span class="line">  <span class="function">RowBlock <span class="title">block</span><span class="params">(&amp;iter-&gt;schema(), FLAGS_scanner_batch_size_rows, &amp;mem)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO(todd): in the future, use the client timeout to set a budget. For now,</span></span><br><span class="line">  <span class="comment">// just use a half second, which should be plenty to amortize call overhead.</span></span><br><span class="line">  <span class="type">int</span> budget_ms = <span class="number">500</span>;</span><br><span class="line">  MonoTime deadline = MonoTime::<span class="built_in">Now</span>() + MonoDelta::<span class="built_in">FromMilliseconds</span>(budget_ms);</span><br><span class="line"></span><br><span class="line">  <span class="type">int64_t</span> rows_scanned = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (iter-&gt;<span class="built_in">HasNext</span>() &amp;&amp; !scanner-&gt;<span class="built_in">has_fulfilled_limit</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PREDICT_FALSE</span>(FLAGS_scanner_inject_latency_on_each_batch_ms &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">      <span class="built_in">SleepFor</span>(MonoDelta::<span class="built_in">FromMilliseconds</span>(FLAGS_scanner_inject_latency_on_each_batch_ms));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//按照block块读取</span></span><br><span class="line">    Status s = iter-&gt;<span class="built_in">NextBlock</span>(&amp;block);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PREDICT_FALSE</span>(!s.<span class="built_in">ok</span>())) &#123;</span><br><span class="line">      <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Copying rows from internal iterator for request &quot;</span></span><br><span class="line">                   &lt;&lt; <span class="built_in">SecureShortDebugString</span>(*req);</span><br><span class="line">      *error_code = TabletServerErrorPB::UNKNOWN_ERROR;</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PREDICT_TRUE</span>(block.<span class="built_in">nrows</span>() &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">      <span class="comment">// Count the number of rows scanned, regardless of predicates or deletions.</span></span><br><span class="line">      <span class="comment">// The collector will separately count the number of rows actually returned to</span></span><br><span class="line">      <span class="comment">// the client.</span></span><br><span class="line">      rows_scanned += block.<span class="built_in">nrows</span>();</span><br><span class="line">      <span class="keyword">if</span> (scanner-&gt;<span class="built_in">spec</span>().<span class="built_in">has_limit</span>()) &#123;</span><br><span class="line">        <span class="type">int64_t</span> rows_left = scanner-&gt;<span class="built_in">spec</span>().<span class="built_in">limit</span>() - scanner-&gt;<span class="built_in">num_rows_returned</span>();</span><br><span class="line">        <span class="built_in">DCHECK_GT</span>(rows_left, <span class="number">0</span>);  <span class="comment">// Guaranteed by has_fulfilled_limit()</span></span><br><span class="line">        block.<span class="built_in">selection_vector</span>()-&gt;<span class="built_in">ClearToSelectAtMost</span>(<span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(rows_left));</span><br><span class="line">      &#125;</span><br><span class="line">      result_collector-&gt;<span class="built_in">HandleRowBlock</span>(scanner.<span class="built_in">get</span>(), block);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (response_size &gt;= batch_size_bytes) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//省略返回数据</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>经过Scan的读取（第一次和第二次），开始初始化RowIterator</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Status Tablet::NewRowIterator(const Schema&amp; projection,</span><br><span class="line">                              unique_ptr&lt;RowwiseIterator&gt;* iter) const &#123;</span><br><span class="line">  RowIteratorOptions opts;</span><br><span class="line">  // Yield current rows.</span><br><span class="line">  opts.snap_to_include = MvccSnapshot(mvcc_);</span><br><span class="line">  opts.projection = &amp;projection;</span><br><span class="line">  return NewRowIterator(std::move(opts), iter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Status Tablet::NewRowIterator(RowIteratorOptions opts,</span><br><span class="line">                              unique_ptr&lt;RowwiseIterator&gt;* iter) const &#123;</span><br><span class="line">  RETURN_IF_STOPPED_OR_CHECK_STATE(kOpen);</span><br><span class="line">  if (metrics_) &#123;</span><br><span class="line">    metrics_-&gt;scans_started-&gt;Increment();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  VLOG_WITH_PREFIX(2) &lt;&lt; &quot;Created new Iterator for snapshot range: (&quot;</span><br><span class="line">                      &lt;&lt; (opts.snap_to_exclude ? opts.snap_to_exclude-&gt;ToString() : &quot;-Inf&quot;)</span><br><span class="line">                      &lt;&lt; &quot;, &quot; &lt;&lt; opts.snap_to_include.ToString() &lt;&lt; &quot;)&quot;;</span><br><span class="line">	//开始初始化迭代器</span><br><span class="line">  iter-&gt;reset(new Iterator(this, std::move(opts)));</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure>

<p>迭代器主要包括，继承自RowwiseIterator的有MergeIterator，UnionIterator，MaterializingIterator，PredicateEvaluatingIterator，集成自ColumnwiseIterator的有DeltaApplier，CFileSet负责读取</p>
<p>这里初始化第一部分：核心Iterator来自NewRowIteratorWithBounds或NewRowIterator方法，Iterator的初始化函数如下，初始化了MergeIterator或UnionIterator。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Status Tablet::Iterator::Init(ScanSpec *spec) &#123;</span><br><span class="line">  RETURN_NOT_OK(tablet_-&gt;CheckHasNotBeenStopped());</span><br><span class="line">  DCHECK(iter_.get() == nullptr);</span><br><span class="line"></span><br><span class="line">  RETURN_NOT_OK(tablet_-&gt;GetMappedReadProjection(projection_, &amp;projection_));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">vector</span>&lt;IterWithBounds&gt; iters;</span><br><span class="line">  <span class="comment">//第一步初始化，memRowSet和diskRowSet的Iterator</span></span><br><span class="line">  RETURN_NOT_OK(tablet_-&gt;CaptureConsistentIterators(opts_, spec, &amp;iters));</span><br><span class="line">  TRACE_COUNTER_INCREMENT(<span class="string">&quot;rowset_iterators&quot;</span>, iters.size());</span><br><span class="line"></span><br><span class="line">  <span class="comment">//第二步初始化</span></span><br><span class="line">  <span class="keyword">switch</span> (opts_.order) &#123;</span><br><span class="line">    <span class="keyword">case</span> ORDERED:</span><br><span class="line">      iter_ = NewMergeIterator(MergeIteratorOptions(opts_.include_deleted_rows), <span class="built_in">std</span>::move(iters));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> UNORDERED:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      iter_ = NewUnionIterator(<span class="built_in">std</span>::move(iters));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//根据规格进行初始化</span></span><br><span class="line">  RETURN_NOT_OK(iter_-&gt;Init(spec));</span><br><span class="line">  <span class="keyword">return</span> Status::OK();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在MergeIterator和UnionIterator的InitSubIterators方法中，都会调用nitAndMaybeWrap初始化内部迭代器。其中初始化的是PredicateEvaluatingIterator，多个迭代器都只是RowwiseIterator的封装，执行了谓词下推，合并等逻辑。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Status <span class="title function_">MergeIterator::InitSubIterators</span><span class="params">(ScanSpec *spec)</span> &#123;</span><br><span class="line">  <span class="comment">// Initialize all the sub iterators.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; i : orig_iters_) &#123;</span><br><span class="line">    ScanSpec *spec_copy = spec != nullptr ? scan_spec_copies_.Construct(*spec) : nullptr;</span><br><span class="line">    RETURN_NOT_OK(InitAndMaybeWrap(&amp;i.iter, spec_copy));</span><br><span class="line">    <span class="built_in">unique_ptr</span>&lt;MergeIterState&gt; <span class="title function_">state</span><span class="params">(new MergeIterState(<span class="built_in">std</span>::move(i)))</span>;</span><br><span class="line">    RETURN_NOT_OK(state-&gt;Init(&amp;decoded_bounds_memory_));</span><br><span class="line">    states_.push_back(*state.release());</span><br><span class="line">  &#125;</span><br><span class="line">  orig_iters_.clear();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Since we handle predicates in all the wrapped iterators, we can clear</span></span><br><span class="line">  <span class="comment">// them here.</span></span><br><span class="line">  <span class="keyword">if</span> (spec != nullptr) &#123;</span><br><span class="line">    spec-&gt;RemovePredicates();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::OK();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PredicateEvaluatingIterator内部包含底层的Iterator，只是一个包装，有自己的谓词下推逻辑，数据读取还是靠底层Iterator</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Status <span class="title function_">UnionIterator::InitSubIterators</span><span class="params">(ScanSpec *spec)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; i : iters_) &#123;</span><br><span class="line">    ScanSpec *spec_copy = spec != nullptr ? scan_spec_copies_.Construct(*spec) : nullptr;</span><br><span class="line">    RETURN_NOT_OK(InitAndMaybeWrap(&amp;i.iter, spec_copy));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The union iterator doesn&#x27;t care about these, so let&#x27;s drop them now to</span></span><br><span class="line">    <span class="comment">// free some memory.</span></span><br><span class="line">    i.encoded_bounds.reset();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Since we handle predicates in all the wrapped iterators, we can clear</span></span><br><span class="line">  <span class="comment">// them here.</span></span><br><span class="line">  <span class="keyword">if</span> (spec != nullptr) &#123;</span><br><span class="line">    spec-&gt;RemovePredicates();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::OK();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Status <span class="title function_">InitAndMaybeWrap</span><span class="params">(<span class="built_in">unique_ptr</span>&lt;RowwiseIterator&gt;* base_iter,</span></span><br><span class="line"><span class="params">                        ScanSpec *spec)</span> &#123;</span><br><span class="line">  RETURN_NOT_OK((*base_iter)-&gt;Init(spec));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (spec != nullptr &amp;&amp; !spec-&gt;predicates().empty()) &#123;</span><br><span class="line">    <span class="comment">// Underlying iterator did not accept all predicates. Wrap it.</span></span><br><span class="line">    <span class="built_in">unique_ptr</span>&lt;RowwiseIterator&gt; <span class="title function_">wrapper</span><span class="params">(new PredicateEvaluatingIterator(<span class="built_in">std</span>::move(*base_iter)))</span>;</span><br><span class="line">    RETURN_NOT_OK(wrapper-&gt;Init(spec));</span><br><span class="line">    *base_iter = <span class="built_in">std</span>::move(wrapper);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::OK();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CaptureConsistentIterators会尝试读取memRowSet和diskRowSet的iterator</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">Tablet::CaptureConsistentIterators</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> RowIteratorOptions&amp; opts,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> ScanSpec* spec,</span></span></span><br><span class="line"><span class="params"><span class="function">    vector&lt;IterWithBounds&gt;* iters)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">shared_lock&lt;rw_spinlock&gt; <span class="title">l</span><span class="params">(component_lock_)</span></span>;</span><br><span class="line">  <span class="built_in">RETURN_IF_STOPPED_OR_CHECK_STATE</span>(kOpen);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Construct all the iterators locally first, so that if we fail</span></span><br><span class="line">  <span class="comment">// in the middle, we don&#x27;t modify the output arguments.</span></span><br><span class="line">  vector&lt;IterWithBounds&gt; ret;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取MemRowSet</span></span><br><span class="line">  <span class="comment">// Grab the memrowset iterator.</span></span><br><span class="line">  &#123;</span><br><span class="line">    unique_ptr&lt;RowwiseIterator&gt; ms_iter;</span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(components_-&gt;memrowset-&gt;<span class="built_in">NewRowIterator</span>(opts, &amp;ms_iter));</span><br><span class="line">    IterWithBounds mrs_iwb;</span><br><span class="line">    mrs_iwb.iter = std::<span class="built_in">move</span>(ms_iter);</span><br><span class="line">    ret.<span class="built_in">emplace_back</span>(std::<span class="built_in">move</span>(mrs_iwb));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//获取在已提交事务中的MemRowSet</span></span><br><span class="line">  <span class="comment">// Capture any iterators for memrowsets whose inserts were added as a part of</span></span><br><span class="line">  <span class="comment">// committed transactions.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; txn_mrs : components_-&gt;txn_memrowsets) &#123;</span><br><span class="line">    unique_ptr&lt;RowwiseIterator&gt; txn_ms_iter;</span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(txn_mrs-&gt;<span class="built_in">NewRowIterator</span>(opts, &amp;txn_ms_iter));</span><br><span class="line">    IterWithBounds txn_mrs_iwb;</span><br><span class="line">    txn_mrs_iwb.iter = std::<span class="built_in">move</span>(txn_ms_iter);</span><br><span class="line">    ret.<span class="built_in">emplace_back</span>(std::<span class="built_in">move</span>(txn_mrs_iwb));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据Key范围找到RowSet</span></span><br><span class="line">  <span class="comment">// Cull row-sets in the case of key-range queries.</span></span><br><span class="line">  <span class="keyword">if</span> (spec != <span class="literal">nullptr</span> &amp;&amp; (spec-&gt;<span class="built_in">lower_bound_key</span>() || spec-&gt;<span class="built_in">exclusive_upper_bound_key</span>())) &#123;</span><br><span class="line">    optional&lt;Slice&gt; lower_bound = spec-&gt;<span class="built_in">lower_bound_key</span>() ?</span><br><span class="line">        <span class="built_in">optional</span>&lt;Slice&gt;(spec-&gt;<span class="built_in">lower_bound_key</span>()-&gt;<span class="built_in">encoded_key</span>()) : <span class="literal">nullopt</span>;</span><br><span class="line">    optional&lt;Slice&gt; upper_bound = spec-&gt;<span class="built_in">exclusive_upper_bound_key</span>() ?</span><br><span class="line">        <span class="built_in">optional</span>&lt;Slice&gt;(spec-&gt;<span class="built_in">exclusive_upper_bound_key</span>()-&gt;<span class="built_in">encoded_key</span>()) : <span class="literal">nullopt</span>;</span><br><span class="line">    vector&lt;RowSet*&gt; interval_sets;</span><br><span class="line">    components_-&gt;rowsets-&gt;<span class="built_in">FindRowSetsIntersectingInterval</span>(lower_bound, upper_bound, &amp;interval_sets);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>* rs : interval_sets) &#123;</span><br><span class="line">      IterWithBounds iwb;</span><br><span class="line">      <span class="built_in">RETURN_NOT_OK_PREPEND</span>(rs-&gt;<span class="built_in">NewRowIteratorWithBounds</span>(opts, &amp;iwb),</span><br><span class="line">                            <span class="built_in">Substitute</span>(<span class="string">&quot;Could not create iterator for rowset $0&quot;</span>,</span><br><span class="line">                                       rs-&gt;<span class="built_in">ToString</span>()));</span><br><span class="line">      ret.<span class="built_in">emplace_back</span>(std::<span class="built_in">move</span>(iwb));</span><br><span class="line">    &#125;</span><br><span class="line">    *iters = std::<span class="built_in">move</span>(ret);</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果没有Key范围，那就查询所有RowSet</span></span><br><span class="line">  <span class="comment">// If there are no encoded predicates of the primary keys, then</span></span><br><span class="line">  <span class="comment">// fall back to grabbing all rowset iterators.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> shared_ptr&lt;RowSet&gt;&amp; rs : components_-&gt;rowsets-&gt;<span class="built_in">all_rowsets</span>()) &#123;</span><br><span class="line">    IterWithBounds iwb;</span><br><span class="line">    <span class="built_in">RETURN_NOT_OK_PREPEND</span>(rs-&gt;<span class="built_in">NewRowIteratorWithBounds</span>(opts, &amp;iwb),</span><br><span class="line">                          <span class="built_in">Substitute</span>(<span class="string">&quot;Could not create iterator for rowset $0&quot;</span>,</span><br><span class="line">                                     rs-&gt;<span class="built_in">ToString</span>()));</span><br><span class="line">    ret.<span class="built_in">emplace_back</span>(std::<span class="built_in">move</span>(iwb));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Swap results into the parameters.</span></span><br><span class="line">  *iters = std::<span class="built_in">move</span>(ret);</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当MemRowSet初始化Iterator时，会直接通过SeekToStart完成数据检索</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MemRowSet::Iterator* <span class="title">MemRowSet::NewIterator</span><span class="params">(<span class="type">const</span> RowIteratorOptions&amp; opts)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MemRowSet::<span class="built_in">Iterator</span>(<span class="built_in">shared_from_this</span>(), tree_.<span class="built_in">NewIterator</span>(), opts);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">MemRowSet::Iterator* <span class="title">MemRowSet::NewIterator</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="comment">// TODO(todd): can we kill this function? should be only used by tests?</span></span><br><span class="line">  RowIteratorOptions opts;</span><br><span class="line">  opts.projection = &amp;<span class="built_in">schema</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">NewIterator</span>(opts);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">MemRowSet::NewRowIterator</span><span class="params">(<span class="type">const</span> RowIteratorOptions&amp; opts,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 unique_ptr&lt;RowwiseIterator&gt;* out)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  out-&gt;<span class="built_in">reset</span>(<span class="built_in">NewIterator</span>(opts));</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br><span class="line">MemRowSet::Iterator::<span class="built_in">Iterator</span>(<span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> MemRowSet&gt;&amp; mrs,</span><br><span class="line">                              MemRowSet::MSBTIter* iter,</span><br><span class="line">                              RowIteratorOptions opts)</span><br><span class="line">    : <span class="built_in">memrowset_</span>(mrs),</span><br><span class="line">      <span class="built_in">iter_</span>(iter),</span><br><span class="line">      <span class="built_in">opts_</span>(std::<span class="built_in">move</span>(opts)),</span><br><span class="line">      <span class="built_in">projector_</span>(</span><br><span class="line">          <span class="built_in">GenerateAppropriateProjector</span>(&amp;mrs-&gt;<span class="built_in">schema_nonvirtual</span>(), opts_.projection)),</span><br><span class="line">      <span class="built_in">delta_projector_</span>(&amp;mrs-&gt;<span class="built_in">schema_nonvirtual</span>(), opts_.projection),</span><br><span class="line">      <span class="built_in">projection_vc_is_deleted_idx_</span>(opts_.projection-&gt;<span class="built_in">first_is_deleted_virtual_column_idx</span>()),</span><br><span class="line">      <span class="built_in">state_</span>(kUninitialized) &#123;</span><br><span class="line">  <span class="comment">// TODO(todd): various code assumes that a newly constructed iterator</span></span><br><span class="line">  <span class="comment">// is pointed at the beginning of the dataset. This causes a redundant</span></span><br><span class="line">  <span class="comment">// seek. Could make this lazy instead, or change the semantics so that</span></span><br><span class="line">  <span class="comment">// a seek is required (probably the latter)</span></span><br><span class="line">  iter_-&gt;<span class="built_in">SeekToStart</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当diskRowSet初始化Iterator时，会初始化MaterializingIterator，而MaterializingIterator包含ColumnwiseIterator</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">DiskRowSet::NewRowIterator</span><span class="params">(<span class="type">const</span> RowIteratorOptions&amp; opts,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  unique_ptr&lt;RowwiseIterator&gt;* out)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK</span>(open_);</span><br><span class="line">  <span class="function">shared_lock&lt;rw_spinlock&gt; <span class="title">l</span><span class="params">(component_lock_)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//可以看出base Iter是通过CFileSet::Iterator检索</span></span><br><span class="line">  <span class="function">shared_ptr&lt;CFileSet::Iterator&gt; <span class="title">base_iter</span><span class="params">(base_data_-&gt;NewIterator(opts.projection,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                                   opts.io_context))</span></span>;</span><br><span class="line">                                                                   </span><br><span class="line">  <span class="comment">//delta是由ColumnwiseIterator包裹的DeltaIterator检索</span></span><br><span class="line">  unique_ptr&lt;ColumnwiseIterator&gt; col_iter;</span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(delta_tracker_-&gt;<span class="built_in">WrapIterator</span>(base_iter, opts, &amp;col_iter));</span><br><span class="line"></span><br><span class="line">  *out = <span class="built_in">NewMaterializingIterator</span>(std::<span class="built_in">move</span>(col_iter));</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>delta data由DeltaTracker检索，合并undo，redo和delta memberstore</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">DeltaTracker::WrapIterator</span><span class="params">(<span class="type">const</span> shared_ptr&lt;CFileSet::Iterator&gt; &amp;base,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> RowIteratorOptions&amp; opts,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  unique_ptr&lt;ColumnwiseIterator&gt;* out)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  unique_ptr&lt;DeltaIterator&gt; iter;</span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(<span class="built_in">NewDeltaIterator</span>(opts, &amp;iter));</span><br><span class="line"></span><br><span class="line">  out-&gt;<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">DeltaApplier</span>(opts, base, std::<span class="built_in">move</span>(iter)));</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">DeltaTracker::NewDeltaIterator</span><span class="params">(<span class="type">const</span> RowIteratorOptions&amp; opts,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      WhichStores which,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      unique_ptr&lt;DeltaIterator&gt;* out)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  std::vector&lt;shared_ptr&lt;DeltaStore&gt;&gt; stores;</span><br><span class="line">  <span class="comment">//收集数据undo redo deltastore的数据</span></span><br><span class="line">  <span class="built_in">CollectStores</span>(&amp;stores, which);</span><br><span class="line">  <span class="comment">//调用DeltaIteratorMerger初始化</span></span><br><span class="line">  <span class="keyword">return</span> DeltaIteratorMerger::<span class="built_in">Create</span>(stores, opts, out);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DeltaTracker::CollectStores</span><span class="params">(vector&lt;shared_ptr&lt;DeltaStore&gt;&gt;* deltas,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 WhichStores which)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;rw_spinlock&gt; <span class="title">lock</span><span class="params">(component_lock_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (which != REDOS_ONLY) &#123;</span><br><span class="line">    <span class="comment">//合并undo</span></span><br><span class="line">    deltas-&gt;<span class="built_in">assign</span>(undo_delta_stores_.<span class="built_in">begin</span>(), undo_delta_stores_.<span class="built_in">end</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (which != UNDOS_ONLY) &#123;</span><br><span class="line">  	<span class="comment">//合并redo和delta</span></span><br><span class="line">    deltas-&gt;<span class="built_in">insert</span>(deltas-&gt;<span class="built_in">end</span>(), redo_delta_stores_.<span class="built_in">begin</span>(), redo_delta_stores_.<span class="built_in">end</span>());</span><br><span class="line">    <span class="keyword">if</span> (dms_exists_ &amp;&amp; !dms_-&gt;<span class="built_in">Empty</span>()) &#123;</span><br><span class="line">      deltas-&gt;<span class="built_in">push_back</span>(dms_);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>base data由CFileSet检索，是ColumnwiseIterator的实现类</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CFileSet</span>:</span>:Iterator : public ColumnwiseIterator &#123;</span><br><span class="line"> public:</span><br><span class="line"></span><br><span class="line">  virtual Status <span class="title function_">Init</span><span class="params">(ScanSpec *spec)</span> OVERRIDE;</span><br><span class="line"></span><br><span class="line">  virtual Status <span class="title function_">PrepareBatch</span><span class="params">(<span class="type">size_t</span> *nrows)</span> OVERRIDE;</span><br><span class="line"></span><br><span class="line">  virtual Status <span class="title function_">InitializeSelectionVector</span><span class="params">(SelectionVector *sel_vec)</span> OVERRIDE;</span><br><span class="line"></span><br><span class="line">  Status <span class="title function_">MaterializeColumn</span><span class="params">(ColumnMaterializationContext *ctx)</span> override;</span><br><span class="line">  <span class="comment">//省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>读取完base data和delta data后，由DeltaApplier合并并返回结果，DeltaApplier是ColumnwiseIterator的实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A DeltaApplier takes in a base ColumnwiseIterator along with a</span></span><br><span class="line"><span class="comment">// DeltaIterator. It is responsible for applying the updates coming</span></span><br><span class="line"><span class="comment">// from the delta iterator to the results of the base iterator.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DeltaApplier</span> <span class="keyword">final</span> : <span class="keyword">public</span> ColumnwiseIterator &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function">Status <span class="title">Init</span><span class="params">(ScanSpec* spec)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function">Status <span class="title">PrepareBatch</span><span class="params">(<span class="type">size_t</span>* nrows)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="comment">//省略其他</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function">Status <span class="title">DeltaApplier::Init</span><span class="params">(ScanSpec* spec)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(base_iter_-&gt;<span class="built_in">Init</span>(spec));</span><br><span class="line">  <span class="built_in">RETURN_NOT_OK</span>(delta_iter_-&gt;<span class="built_in">Init</span>(spec));</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">DeltaApplier::MaterializeColumn</span><span class="params">(ColumnMaterializationContext* ctx)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK</span>(!first_prepare_) &lt;&lt; <span class="string">&quot;PrepareBatch() must be called at least once&quot;</span>;</span><br><span class="line">  <span class="comment">// Data with updates cannot be evaluated at the decoder-level.</span></span><br><span class="line">  <span class="keyword">if</span> (delta_iter_-&gt;<span class="built_in">MayHaveDeltas</span>()) &#123;</span><br><span class="line">    ctx-&gt;<span class="built_in">SetDecoderEvalNotSupported</span>();</span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(base_iter_-&gt;<span class="built_in">MaterializeColumn</span>(ctx));</span><br><span class="line">    <span class="comment">//应用delta的数据更新</span></span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(delta_iter_-&gt;<span class="built_in">ApplyUpdates</span>(ctx-&gt;<span class="built_in">col_idx</span>(), ctx-&gt;<span class="built_in">block</span>(), *ctx-&gt;<span class="built_in">sel</span>()));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">RETURN_NOT_OK</span>(base_iter_-&gt;<span class="built_in">MaterializeColumn</span>(ctx));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>Kudu读取流程：<a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/496397719" >https://zhuanlan.zhihu.com/p/496397719<i class="fas fa-external-link-alt"></i></a></p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/3_Hive/"
                                   title="Hive初识"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Hive初识</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/1_%E3%80%8APresto%E5%AE%9E%E6%88%98%E3%80%8B%E7%AC%94%E8%AE%B0/"
                                   title="《Presto实战》笔记"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">《Presto实战》笔记</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85"><span class="nav-text">Docker本地安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-text">原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Tablet"><span class="nav-text">Tablet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%8A%A0%E9%80%9F"><span class="nav-text">查询加速</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%8C%BA"><span class="nav-text">分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95"><span class="nav-text">索引</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"><span class="nav-text">源码阅读</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-text">参考</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2025
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">EmiyaQ</a>
        
    </div>

    <div class="theme-info info-item">
        由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;&&nbsp;主题&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85"><span class="nav-text">Docker本地安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-text">原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Tablet"><span class="nav-text">Tablet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%8A%A0%E9%80%9F"><span class="nav-text">查询加速</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%8C%BA"><span class="nav-text">分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95"><span class="nav-text">索引</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"><span class="nav-text">源码阅读</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-text">参考</span></a></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->

    
<script src="/js/lazyload.js"></script>



<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
